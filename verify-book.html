<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://lyqpxcilniqzurevetae.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cXB4Y2lsbmlxenVyZXZldGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDAyMTQsImV4cCI6MjA4NTExNjIxNH0.40ZbAatkMBFHacQGCpiNYpjcKQoZik-Xvqx3bG46x7c";
  
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let photoFile = null;
  let videoFile = null;
  let verifiedCode = null;
  let verifiedBookType = null;

  async function checkAuth() {
    try {
      const { data: { session }, error } = await window.supabase.auth.getSession();
      
      const authCheck = document.getElementById('authCheck');
      const verificationForm = document.getElementById('verificationForm');

      if (error) {
        console.error('Auth error:', error);
        authCheck.innerHTML = '<p style="color: var(--error);">Error checking authentication. Please try again.</p><a href="./login.html" class="btn" style="display: inline-block; text-decoration: none; max-width: 200px; margin: 20px auto;">Go to Login</a>';
        return;
      }

      if (!session) {
        authCheck.innerHTML = '<p style="color: var(--error);">You must be logged in to verify your book.</p><a href="./login.html" class="btn" style="display: inline-block; text-decoration: none; max-width: 200px; margin: 20px auto;">Go to Login</a>';
        return;
      }

      authCheck.classList.add('hidden');
      verificationForm.classList.remove('hidden');
    } catch (err) {
      console.error('Unexpected error:', err);
      const authCheck = document.getElementById('authCheck');
      authCheck.innerHTML = '<p style="color: var(--error);">An error occurred. Please refresh the page.</p><a href="./login.html" class="btn" style="display: inline-block; text-decoration: none; max-width: 200px; margin: 20px auto;">Go to Login</a>';
    }
  }

  document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
    const codeInput = document.getElementById('bookCode');
    const code = codeInput.value.trim().toUpperCase();
    const btn = document.getElementById('verifyCodeBtn');
    const progressDiv = document.getElementById('codeProgress');

    if (!code) {
      showMessage('Please enter your book code', 'error');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Checking code...';
    progressDiv.textContent = 'Verifying with database...';

    try {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        throw new Error('Not authenticated');
      }

      const { data: codeData, error: codeError } = await window.supabase
        .from('book_verification_codes')
        .select('*')
        .eq('code', code)
        .single();

      if (codeError || !codeData) {
        throw new Error('Invalid book code. Please check and try again.');
      }

      if (codeData.is_used) {
        throw new Error('This code has already been used.');
      }

      verifiedCode = code;
      verifiedBookType = codeData.book_name;

      // Store in browser so it persists on refresh
      sessionStorage.setItem('verifiedCode', code);
      sessionStorage.setItem('verifiedBookType', codeData.book_name);

      document.getElementById('codeStep').classList.add('hidden');
      document.getElementById('bookForm').classList.remove('hidden');
      
      const bookNames = {
        'soulful': 'Soulful Bollywood Melodies',
        'peppy': 'Peppy Bollywood Melodies',
        'romantic': 'Romantic Bollywood Melodies',
        'classic': 'Classic Bollywood Melodies'
      };

      document.getElementById('verifiedCodeDisplay').innerHTML = '<div class="verified-info">‚úì Code Verified: ' + (bookNames[verifiedBookType] || verifiedBookType) + '</div>';

      showMessage('Perfect! Your code is verified. Now lets complete the process with a quick photo.', 'success');

    } catch (error) {
      console.error('Error:', error);
      showMessage(error.message || 'Failed to verify code', 'error');
      btn.disabled = false;
      btn.textContent = 'Verify Code';
      progressDiv.textContent = '';
    }
  });

  document.getElementById('photoInput').addEventListener('change', (e) => {
    photoFile = e.target.files[0];
    if (photoFile) {
      document.getElementById('photoLabel').classList.add('has-file');
      document.getElementById('photoText').textContent = '‚úì Photo selected';
      document.getElementById('photoName').textContent = photoFile.name;
    }
  });

  document.getElementById('videoInput').addEventListener('change', (e) => {
    videoFile = e.target.files[0];
    if (videoFile) {
      document.getElementById('videoLabel').classList.add('has-file');
      document.getElementById('videoText').textContent = '‚úì Video selected';
      document.getElementById('videoName').textContent = videoFile.name;
    }
  });

  function updateProgress(message) {
    document.getElementById('progressDetail').textContent = message;
  }

  document.getElementById('bookForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!verifiedCode || !verifiedBookType) {
      showMessage('Please verify your book code first', 'error');
      return;
    }

    if (!photoFile) {
      showMessage('Please upload a photo of your book', 'error');
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    updateProgress('Starting verification...');

    try {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        throw new Error('Not authenticated');
      }
      
      const userId = session.user.id;
      console.log('‚úÖ User ID:', userId);

      updateProgress('Uploading photo...');
      const photoExt = photoFile.name.split('.').pop();
      const photoPath = userId + '/book-' + verifiedBookType + '-' + Date.now() + '.' + photoExt;
      
      const { data: photoData, error: photoError } = await window.supabase.storage
        .from('book-verifications')
        .upload(photoPath, photoFile);

      if (photoError) {
        console.error('‚ùå Photo upload error:', photoError);
        throw new Error('Photo upload failed: ' + photoError.message);
      }
      console.log('‚úÖ Photo uploaded');

      updateProgress('Marking code as used...');
      
      const { data: updateData, error: codeUpdateError } = await window.supabase
        .from('book_verification_codes')
        .update({ 
          is_used: true,
          used_by_user_id: userId,
          used_at: new Date().toISOString()
        })
        .eq('code', verifiedCode)
        .select();

      if (codeUpdateError) {
        console.error('‚ùå Code update error:', codeUpdateError);
        throw new Error('Failed to mark code as used: ' + codeUpdateError.message);
      }
      console.log('‚úÖ Code marked as used');

      updateProgress('Updating your account...');
      
      const { data: currentProfile, error: fetchError } = await window.supabase
        .from('profiles')
        .select('books_owned')
        .eq('id', userId)
        .maybeSingle();

      if (fetchError && fetchError.code !== 'PGRST116') {
        console.error('‚ùå Profile fetch error:', fetchError);
        throw new Error('Could not fetch profile');
      }

      const existingBooks = currentProfile?.books_owned || [];
      const updatedBooks = existingBooks.includes(verifiedBookType) 
        ? existingBooks 
        : existingBooks.concat([verifiedBookType]);

      console.log('üìö Updating books from', existingBooks, 'to', updatedBooks);

      const { error: profileError } = await window.supabase
        .from('profiles')
        .update({ 
          is_book_owner: true,
          books_owned: updatedBooks
        })
        .eq('id', userId);

      if (profileError) {
        console.error('‚ùå Profile update error:', profileError);
        throw new Error('Failed to update profile: ' + profileError.message);
      }
      console.log('‚úÖ Profile updated - is_book_owner set to true');

      let videoUploaded = false;
      if (videoFile) {
        try {
          updateProgress('Uploading video...');
          const videoExt = videoFile.name.split('.').pop();
          const videoPath = userId + '/video-' + verifiedBookType + '-' + Date.now() + '.' + videoExt;
          
          const { data: videoData, error: videoError } = await window.supabase.storage
            .from('book-videos')
            .upload(videoPath, videoFile);

          if (!videoError) {
            console.log('‚úÖ Video uploaded');
            
            updateProgress('Checking bonus eligibility...');
            
            const { data: profileData, error: profileCheckError } = await window.supabase
              .from('profiles')
              .select('video_bonus_claimed')
              .eq('id', userId)
              .maybeSingle();

            if (profileCheckError && profileCheckError.code !== 'PGRST116') {
              console.error('‚ö†Ô∏è Bonus check error:', profileCheckError);
            }

            if (!profileData?.video_bonus_claimed) {
              updateProgress('Adding bonus credit...');
              
              const { data: existingCredits, error: fetchCreditsError } = await window.supabase
                .from('user_credits')
                .select('balance')
                .eq('user_id', userId)
                .maybeSingle();

              if (fetchCreditsError && fetchCreditsError.code !== 'PGRST116') {
                console.error('‚ö†Ô∏è Credits fetch error:', fetchCreditsError);
              }

              if (existingCredits) {
                const newBalance = existingCredits.balance + 1;
                
                const { error: updateCreditsError } = await window.supabase
                  .from('user_credits')
                  .update({ 
                    balance: newBalance,
                    updated_at: new Date().toISOString()
                  })
                  .eq('user_id', userId);

                if (updateCreditsError) {
                  console.error('‚ö†Ô∏è Credits update error:', updateCreditsError);
                } else {
                  console.log('‚úÖ Credits updated to', newBalance);
                }
              } else {
                const { error: insertCreditsError } = await window.supabase
                  .from('user_credits')
                  .insert({ 
                    user_id: userId,
                    balance: 1,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                  });

                if (insertCreditsError) {
                  console.error('‚ö†Ô∏è Credits insert error:', insertCreditsError);
                } else {
                  console.log('‚úÖ Credits created: 1');
                }
              }

              const { error: markBonusError } = await window.supabase
                .from('profiles')
                .update({ video_bonus_claimed: true })
                .eq('id', userId);

              if (markBonusError) {
                console.error('‚ö†Ô∏è Bonus mark error:', markBonusError);
              } else {
                videoUploaded = true;
                console.log('‚úÖ Bonus marked as claimed');
              }
            } else {
              console.log('‚ÑπÔ∏è User already claimed video bonus');
            }
          } else {
            console.error('‚ö†Ô∏è Video upload error:', videoError);
          }
        } catch (videoError) {
          console.error('‚ö†Ô∏è Video processing error:', videoError);
        }
      }

      updateProgress('');
      
      let successMessage = 'üéâ Congratulations! Your book is verified and you now have access to exclusive book owner pricing.';
      if (videoUploaded) {
        successMessage += ' Plus, we have added 1 free song credit to your account as a thank you for sharing your video! üéÅ';
      } else if (videoFile) {
        successMessage += ' Your video was uploaded successfully. (Note: The bonus credit is a one-time reward that you have already claimed previously.)';
      }
      
      showMessage(successMessage, 'success');
      submitBtn.textContent = '‚úì Verified!';

      // Clear the stored code since verification is complete
      sessionStorage.removeItem('verifiedCode');
      sessionStorage.removeItem('verifiedBookType');

      console.log('‚úÖ Verification complete! Redirecting to homepage...');

      setTimeout(() => {
        window.location.href = 'https://riashandilya-svg.github.io/classicbollywoodmelodies/';
      }, 3000);

    } catch (error) {
      console.error('‚ùå Error:', error);
      showMessage(error.message || 'Verification failed. Please try again.', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Complete Verification & Unlock Discounts';
      updateProgress('');
    }
  });

  function showMessage(text, type) {
    const messageArea = document.getElementById('messageArea');
    messageArea.className = type === 'error' ? 'error-text' : 'success-text';
    messageArea.innerHTML = '<p>' + text + '</p>';
  }

  checkAuth();

  // Check if we have a verified code from before (in case of page refresh)
  const savedCode = sessionStorage.getItem('verifiedCode');
  const savedBookType = sessionStorage.getItem('verifiedBookType');
  if (savedCode && savedBookType) {
    verifiedCode = savedCode;
    verifiedBookType = savedBookType;
    
    // Skip code step and show the form
    document.getElementById('codeStep').classList.add('hidden');
    document.getElementById('bookForm').classList.remove('hidden');
    
    const bookNames = {
      'soulful': 'Soulful Bollywood Melodies',
      'peppy': 'Peppy Bollywood Melodies',
      'romantic': 'Romantic Bollywood Melodies',
      'classic': 'Classic Bollywood Melodies'
    };
    
    document.getElementById('verifiedCodeDisplay').innerHTML = '<div class="verified-info">‚úì Code Verified: ' + (bookNames[savedBookType] || savedBookType) + '</div>';
  }
</script>

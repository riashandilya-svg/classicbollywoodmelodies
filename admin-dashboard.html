<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Classic Bollywood Melodies</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 2rem; margin-bottom: 10px; }
    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      overflow-x: auto;
    }
    .tab {
      padding: 15px 25px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 500;
      color: #495057;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .tab:hover { background: #e9ecef; }
    .tab.active {
      background: white;
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }
    .tab-content {
      padding: 30px;
      display: none;
    }
    .tab-content.active { display: block; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-card .subtitle {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group input:read-only {
      background: #f8f9fa;
      cursor: not-allowed;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover { background: #218838; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table thead {
      background: #f8f9fa;
    }
    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    table th {
      font-weight: 600;
      color: #495057;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    table tr:hover {
      background: #f8f9fa;
    }
    
    .pricing-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .pricing-section h3 {
      color: #495057;
      margin-bottom: 20px;
      font-size: 1.3rem;
    }
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .exchange-rates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .rate-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #dee2e6;
      text-align: center;
    }
    .rate-card .currency {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }
    .rate-card .rate {
      font-size: 1.5rem;
      color: #667eea;
      font-weight: bold;
    }
    .rate-card .base {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .date-range-picker {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .date-range-picker .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .pricing-grid {
        grid-template-columns: 1fr;
      }
      .tabs {
        flex-wrap: wrap;
      }
      .date-range-picker {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéµ Admin Dashboard</h1>
      <p>Classic Bollywood Melodies - Control Center</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="overview">üìä Overview</button>
      <button class="tab" data-tab="pricing">üí∞ Pricing</button>
      <button class="tab" data-tab="exchange">üåç Exchange Rates</button>
      <button class="tab" data-tab="users">üë• Users</button>
      <button class="tab" data-tab="purchases">üí≥ All Purchases</button>
      <button class="tab" data-tab="bundles">üéÅ Bundle Purchases</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Users</h3>
          <div class="value" id="totalUsers">-</div>
          <div class="subtitle">Registered accounts</div>
        </div>
        <div class="stat-card">
          <h3>Book Owners</h3>
          <div class="value" id="bookOwners">-</div>
          <div class="subtitle">Premium users</div>
        </div>
        <div class="stat-card">
          <h3>Total Purchases</h3>
          <div class="value" id="totalPurchases">-</div>
          <div class="subtitle">All transactions</div>
        </div>
        <div class="stat-card">
          <h3>Bundle Purchases</h3>
          <div class="value" id="bundlePurchases">-</div>
          <div class="subtitle">5-song packs sold</div>
        </div>
      </div>

      <h2 style="margin-bottom: 20px;">üí∏ Revenue Analytics</h2>
      
      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h3>This Month</h3>
          <div class="value" id="revenueMonth">-</div>
          <div class="subtitle" id="revenueMonthDetails">Loading...</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);">
          <h3>Last 90 Days</h3>
          <div class="value" id="revenue90">-</div>
          <div class="subtitle" id="revenue90Details">Loading...</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <h3>This Year</h3>
          <div class="value" id="revenueYear">-</div>
          <div class="subtitle" id="revenueYearDetails">Loading...</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
          <h3>All Time</h3>
          <div class="value" id="revenueTotal">-</div>
          <div class="subtitle" id="revenueTotalDetails">Loading...</div>
        </div>
      </div>

      <!-- Custom Date Range -->
      <div class="pricing-section">
        <h3>üìÖ Custom Date Range Revenue</h3>
        <div class="date-range-picker">
          <div class="form-group">
            <label>From Date</label>
            <input type="date" id="dateFrom" />
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input type="date" id="dateTo" />
          </div>
          <button class="btn btn-primary" onclick="calculateCustomRange()">
            Calculate Revenue
          </button>
        </div>
        <div id="customRangeResult"></div>
      </div>
    </div>

    <!-- PRICING TAB -->
    <div id="pricing" class="tab-content">
      <div class="alert alert-info">
        üí° <strong>Tip:</strong> Enter prices in normal format (e.g., 8.00 for $8, 150 for ‚Çπ150). The system automatically converts to cents/paise.
      </div>

      <div class="pricing-section">
        <h3>üá∫üá∏ USD Pricing (Base Currency)</h3>
        <h4 style="margin: 15px 0 10px 0; color: #667eea;">üìö With Books</h4>
        <div class="pricing-grid">
          <div class="form-group">
            <label>1st Song</label>
            <input type="number" step="0.01" id="usd_withBooks_first" placeholder="8.00" />
          </div>
          <div class="form-group">
            <label>2nd Song</label>
            <input type="number" step="0.01" id="usd_withBooks_second" placeholder="7.00" />
          </div>
          <div class="form-group">
            <label>3rd+ Songs</label>
            <input type="number" step="0.01" id="usd_withBooks_third" placeholder="7.00" />
          </div>
          <div class="form-group">
            <label>5-Song Bundle</label>
            <input type="number" step="0.01" id="usd_withBooks_bundle" placeholder="34.00" />
          </div>
        </div>
        
        <h4 style="margin: 15px 0 10px 0; color: #667eea;">üìñ Without Books</h4>
        <div class="pricing-grid">
          <div class="form-group">
            <label>1st Song</label>
            <input type="number" step="0.01" id="usd_withoutBooks_first" placeholder="10.00" />
          </div>
          <div class="form-group">
            <label>2nd Song</label>
            <input type="number" step="0.01" id="usd_withoutBooks_second" placeholder="9.00" />
          </div>
          <div class="form-group">
            <label>3rd+ Songs</label>
            <input type="number" step="0.01" id="usd_withoutBooks_third" placeholder="8.00" />
          </div>
          <div class="form-group">
            <label>5-Song Bundle</label>
            <input type="number" step="0.01" id="usd_withoutBooks_bundle" placeholder="40.00" />
          </div>
        </div>
      </div>

      <div class="pricing-section">
        <h3>üáÆüá≥ INR Pricing</h3>
        <h4 style="margin: 15px 0 10px 0; color: #667eea;">üìö With Books</h4>
        <div class="pricing-grid">
          <div class="form-group">
            <label>1st Song</label>
            <input type="number" step="0.01" id="inr_withBooks_first" placeholder="150.00" />
          </div>
          <div class="form-group">
            <label>2nd Song</label>
            <input type="number" step="0.01" id="inr_withBooks_second" placeholder="129.00" />
          </div>
          <div class="form-group">
            <label>3rd+ Songs</label>
            <input type="number" step="0.01" id="inr_withBooks_third" placeholder="100.00" />
          </div>
          <div class="form-group">
            <label>5-Song Bundle</label>
            <input type="number" step="0.01" id="inr_withBooks_bundle" placeholder="550.00" />
          </div>
        </div>
        
        <h4 style="margin: 15px 0 10px 0; color: #667eea;">üìñ Without Books</h4>
        <div class="pricing-grid">
          <div class="form-group">
            <label>1st Song</label>
            <input type="number" step="0.01" id="inr_withoutBooks_first" placeholder="200.00" />
          </div>
          <div class="form-group">
            <label>2nd Song</label>
            <input type="number" step="0.01" id="inr_withoutBooks_second" placeholder="180.00" />
          </div>
          <div class="form-group">
            <label>3rd+ Songs</label>
            <input type="number" step="0.01" id="inr_withoutBooks_third" placeholder="150.00" />
          </div>
          <div class="form-group">
            <label>5-Song Bundle</label>
            <input type="number" step="0.01" id="inr_withoutBooks_bundle" placeholder="850.00" />
          </div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="savePricing()" style="font-size: 18px; padding: 15px 40px;">
          üíæ Save All Pricing Changes
        </button>
      </div>

      <div id="pricingMessage" style="margin-top: 20px;"></div>
    </div>

    <!-- EXCHANGE RATES TAB -->
    <div id="exchange" class="tab-content">
      <div class="alert alert-info">
        üåç Exchange rates are fetched from live API. INR is the base currency (1.0). Click "Update Now" to refresh rates.
      </div>

      <div style="text-align: center; margin-bottom: 30px;">
        <button class="btn btn-success" onclick="updateExchangeRates()" style="font-size: 18px; padding: 15px 40px;">
          üîÑ Update Exchange Rates Now
        </button>
        <div id="lastUpdated" style="margin-top: 15px; color: #6c757d; font-size: 0.9rem;"></div>
      </div>

      <div class="exchange-rates-grid" id="exchangeRatesGrid">
        <div class="loading">Loading exchange rates...</div>
      </div>

      <div id="exchangeMessage" style="margin-top: 20px;"></div>
    </div>

    <!-- USERS TAB -->
    <div id="users" class="tab-content">
      <div class="alert alert-info">
        üë• Manage user accounts and book ownership status
      </div>
      <div id="usersTable">
        <div class="loading">Loading users...</div>
      </div>
    </div>

    <!-- PURCHASES TAB -->
    <div id="purchases" class="tab-content">
      <div class="alert alert-info">
        üí≥ View all purchase transactions
      </div>
      <div id="purchasesTable">
        <div class="loading">Loading purchases...</div>
      </div>
    </div>

    <!-- BUNDLES TAB -->
    <div id="bundles" class="tab-content">
      <div class="alert alert-info">
        üéÅ Track bundle purchases and credit usage
      </div>
      <div id="bundlesTable">
        <div class="loading">Loading bundle purchases...</div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://lyqpxcilniqzurevetae.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cXB4Y2lsbmlxenVyZXZldGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcxMTYxNzcsImV4cCI6MjA1MjY5MjE3N30.P7vYO7s8fLqG6EkB9_SfqRQPKXFLAaI_LGQbYaXqWis';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'users') loadUsers();
        if (tabName === 'purchases') loadPurchases();
        if (tabName === 'bundles') loadBundles();
        if (tabName === 'exchange') loadExchangeRates();
      });
    });

    // Set default date to today
    document.getElementById('dateTo').valueAsDate = new Date();
    document.getElementById('dateFrom').valueAsDate = new Date(new Date().setDate(new Date().getDate() - 30));

    async function loadOverview() {
      try {
        // Total users
        const { count: userCount } = await supabase
          .from('profiles')
          .select('*', { count: 'exact', head: true });
        document.getElementById('totalUsers').textContent = userCount || 0;

        // Book owners
        const { count: bookCount } = await supabase
          .from('profiles')
          .select('*', { count: 'exact', head: true })
          .eq('is_book_owner', true);
        document.getElementById('bookOwners').textContent = bookCount || 0;

        // Total purchases
        const { count: purchaseCount } = await supabase
          .from('purchases')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'paid');
        document.getElementById('totalPurchases').textContent = purchaseCount || 0;

        // Bundle purchases
        const { count: bundleCount } = await supabase
          .from('purchases')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'paid')
          .eq('song_id', 'pack:5');
        document.getElementById('bundlePurchases').textContent = bundleCount || 0;

        // Revenue calculations
        await calculateRevenue();
      } catch (error) {
        console.error('Error loading overview:', error);
      }
    }

    async function calculateRevenue() {
      try {
        const { data: purchases } = await supabase
          .from('purchases')
          .select('amount, currency, created_at')
          .eq('status', 'paid');

        if (!purchases) return;

        const now = new Date();
        const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
        const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
        const yearStart = new Date(now.getFullYear(), 0, 1);

        let monthRevenue = { INR: 0, USD: 0 };
        let ninetyRevenue = { INR: 0, USD: 0 };
        let yearRevenue = { INR: 0, USD: 0 };
        let totalRevenue = { INR: 0, USD: 0 };

        purchases.forEach(p => {
          const date = new Date(p.created_at);
          const amount = (p.amount || 0) / 100; // Convert from paise/cents
          const currency = p.currency || 'INR';

          if (!totalRevenue[currency]) totalRevenue[currency] = 0;
          totalRevenue[currency] += amount;

          if (date >= monthAgo) {
            if (!monthRevenue[currency]) monthRevenue[currency] = 0;
            monthRevenue[currency] += amount;
          }

          if (date >= ninetyDaysAgo) {
            if (!ninetyRevenue[currency]) ninetyRevenue[currency] = 0;
            ninetyRevenue[currency] += amount;
          }

          if (date >= yearStart) {
            if (!yearRevenue[currency]) yearRevenue[currency] = 0;
            yearRevenue[currency] += amount;
          }
        });

        // Display month revenue
        document.getElementById('revenueMonth').textContent = formatMultiCurrency(monthRevenue);
        document.getElementById('revenueMonthDetails').textContent = formatCurrencyBreakdown(monthRevenue);

        // Display 90 days revenue
        document.getElementById('revenue90').textContent = formatMultiCurrency(ninetyRevenue);
        document.getElementById('revenue90Details').textContent = formatCurrencyBreakdown(ninetyRevenue);

        // Display year revenue
        document.getElementById('revenueYear').textContent = formatMultiCurrency(yearRevenue);
        document.getElementById('revenueYearDetails').textContent = formatCurrencyBreakdown(yearRevenue);

        // Display total revenue
        document.getElementById('revenueTotal').textContent = formatMultiCurrency(totalRevenue);
        document.getElementById('revenueTotalDetails').textContent = formatCurrencyBreakdown(totalRevenue);

      } catch (error) {
        console.error('Error calculating revenue:', error);
      }
    }

    function formatMultiCurrency(revenues) {
      const parts = [];
      if (revenues.INR > 0) parts.push(`‚Çπ${revenues.INR.toFixed(2)}`);
      if (revenues.USD > 0) parts.push(`$${revenues.USD.toFixed(2)}`);
      
      // Add other currencies if present
      Object.keys(revenues).forEach(curr => {
        if (curr !== 'INR' && curr !== 'USD' && revenues[curr] > 0) {
          parts.push(`${curr} ${revenues[curr].toFixed(2)}`);
        }
      });
      
      return parts.join(' + ') || '‚Çπ0.00';
    }

    function formatCurrencyBreakdown(revenues) {
      const parts = [];
      Object.keys(revenues).forEach(curr => {
        if (revenues[curr] > 0) {
          const symbol = curr === 'INR' ? '‚Çπ' : curr === 'USD' ? '$' : curr;
          parts.push(`${symbol}${revenues[curr].toFixed(2)}`);
        }
      });
      return parts.join(' | ') || 'No revenue';
    }

    async function calculateCustomRange() {
      const fromDate = document.getElementById('dateFrom').value;
      const toDate = document.getElementById('dateTo').value;

      if (!fromDate || !toDate) {
        alert('Please select both dates');
        return;
      }

      try {
        const { data: purchases } = await supabase
          .from('purchases')
          .select('amount, currency, created_at')
          .eq('status', 'paid')
          .gte('created_at', fromDate)
          .lte('created_at', toDate + 'T23:59:59');

        let revenue = { INR: 0, USD: 0 };
        let count = 0;

        purchases?.forEach(p => {
          count++;
          const amount = (p.amount || 0) / 100;
          const currency = p.currency || 'INR';
          if (!revenue[currency]) revenue[currency] = 0;
          revenue[currency] += amount;
        });

        const resultDiv = document.getElementById('customRangeResult');
        resultDiv.innerHTML = `
          <div class="alert alert-success" style="margin-top: 20px;">
            <h3 style="margin-bottom: 10px;">üìä Results for ${fromDate} to ${toDate}</h3>
            <div style="font-size: 1.5rem; font-weight: bold; margin: 15px 0;">
              ${formatMultiCurrency(revenue)}
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
              ${count} transaction${count !== 1 ? 's' : ''} | ${formatCurrencyBreakdown(revenue)}
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error calculating custom range:', error);
        alert('Error calculating revenue');
      }
    }

    async function loadPricing() {
      try {
        const { data } = await supabase
          .from('pricing_config')
          .select('config')
          .eq('id', 1)
          .single();

        if (data?.config) {
          const config = data.config;
          
          // USD prices (convert from cents to dollars)
          if (config.USD) {
            document.getElementById('usd_withBooks_first').value = (config.USD.withBooks.first / 100).toFixed(2);
            document.getElementById('usd_withBooks_second').value = (config.USD.withBooks.second / 100).toFixed(2);
            document.getElementById('usd_withBooks_third').value = (config.USD.withBooks.third / 100).toFixed(2);
            document.getElementById('usd_withBooks_bundle').value = (config.USD.withBooks.bundle / 100).toFixed(2);
            
            document.getElementById('usd_withoutBooks_first').value = (config.USD.withoutBooks.first / 100).toFixed(2);
            document.getElementById('usd_withoutBooks_second').value = (config.USD.withoutBooks.second / 100).toFixed(2);
            document.getElementById('usd_withoutBooks_third').value = (config.USD.withoutBooks.third / 100).toFixed(2);
            document.getElementById('usd_withoutBooks_bundle').value = (config.USD.withoutBooks.bundle / 100).toFixed(2);
          }
          
          // INR prices (convert from paise to rupees)
          if (config.INR) {
            document.getElementById('inr_withBooks_first').value = (config.INR.withBooks.first / 100).toFixed(2);
            document.getElementById('inr_withBooks_second').value = (config.INR.withBooks.second / 100).toFixed(2);
            document.getElementById('inr_withBooks_third').value = (config.INR.withBooks.third / 100).toFixed(2);
            document.getElementById('inr_withBooks_bundle').value = (config.INR.withBooks.bundle / 100).toFixed(2);
            
            document.getElementById('inr_withoutBooks_first').value = (config.INR.withoutBooks.first / 100).toFixed(2);
            document.getElementById('inr_withoutBooks_second').value = (config.INR.withoutBooks.second / 100).toFixed(2);
            document.getElementById('inr_withoutBooks_third').value = (config.INR.withoutBooks.third / 100).toFixed(2);
            document.getElementById('inr_withoutBooks_bundle').value = (config.INR.withoutBooks.bundle / 100).toFixed(2);
          }
        }
      } catch (error) {
        console.error('Error loading pricing:', error);
      }
    }

    async function savePricing() {
      try {
        const msgDiv = document.getElementById('pricingMessage');
        msgDiv.innerHTML = '<div class="alert alert-info">Saving pricing...</div>';

        // Get current config first
        const { data: current } = await supabase
          .from('pricing_config')
          .select('config')
          .eq('id', 1)
          .single();

        const config = current?.config || {};

        // Update USD prices (convert dollars to cents)
        config.USD = {
          withBooks: {
            first: Math.round(parseFloat(document.getElementById('usd_withBooks_first').value) * 100),
            second: Math.round(parseFloat(document.getElementById('usd_withBooks_second').value) * 100),
            third: Math.round(parseFloat(document.getElementById('usd_withBooks_third').value) * 100),
            bundle: Math.round(parseFloat(document.getElementById('usd_withBooks_bundle').value) * 100),
          },
          withoutBooks: {
            first: Math.round(parseFloat(document.getElementById('usd_withoutBooks_first').value) * 100),
            second: Math.round(parseFloat(document.getElementById('usd_withoutBooks_second').value) * 100),
            third: Math.round(parseFloat(document.getElementById('usd_withoutBooks_third').value) * 100),
            bundle: Math.round(parseFloat(document.getElementById('usd_withoutBooks_bundle').value) * 100),
          }
        };

        // Update INR prices (convert rupees to paise)
        config.INR = {
          withBooks: {
            first: Math.round(parseFloat(document.getElementById('inr_withBooks_first').value) * 100),
            second: Math.round(parseFloat(document.getElementById('inr_withBooks_second').value) * 100),
            third: Math.round(parseFloat(document.getElementById('inr_withBooks_third').value) * 100),
            bundle: Math.round(parseFloat(document.getElementById('inr_withBooks_bundle').value) * 100),
          },
          withoutBooks: {
            first: Math.round(parseFloat(document.getElementById('inr_withoutBooks_first').value) * 100),
            second: Math.round(parseFloat(document.getElementById('inr_withoutBooks_second').value) * 100),
            third: Math.round(parseFloat(document.getElementById('inr_withoutBooks_third').value) * 100),
            bundle: Math.round(parseFloat(document.getElementById('inr_withoutBooks_bundle').value) * 100),
          }
        };

        const { error } = await supabase
          .from('pricing_config')
          .upsert({
            id: 1,
            config: config,
            updated_at: new Date().toISOString()
          });

        if (error) throw error;

        msgDiv.innerHTML = '<div class="alert alert-success">‚úÖ Pricing updated successfully!</div>';
        setTimeout(() => msgDiv.innerHTML = '', 3000);
      } catch (error) {
        console.error('Error saving pricing:', error);
        document.getElementById('pricingMessage').innerHTML = 
          `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
      }
    }

    async function loadExchangeRates() {
      try {
        const { data } = await supabase
          .from('pricing_config')
          .select('config')
          .eq('id', 1)
          .single();

        const rates = data?.config?.exchangeRates || {};
        const lastUpdated = data?.config?.lastUpdated;

        const grid = document.getElementById('exchangeRatesGrid');
        grid.innerHTML = '';

        // Sort currencies: INR first, then alphabetically
        const currencies = Object.keys(rates).sort((a, b) => {
          if (a === 'INR') return -1;
          if (b === 'INR') return 1;
          return a.localeCompare(b);
        });

        currencies.forEach(currency => {
          const rate = rates[currency];
          const isBase = currency === 'INR';
          
          const card = document.createElement('div');
          card.className = `rate-card ${isBase ? 'base' : ''}`;
          card.innerHTML = `
            <div class="currency">${currency} ${isBase ? '(Base)' : ''}</div>
            <div class="rate">${isBase ? '1.00' : rate.toFixed(4)}</div>
          `;
          grid.appendChild(card);
        });

        if (lastUpdated) {
          document.getElementById('lastUpdated').textContent = 
            `Last updated: ${new Date(lastUpdated).toLocaleString()}`;
        }
      } catch (error) {
        console.error('Error loading exchange rates:', error);
      }
    }

    async function updateExchangeRates() {
      const msgDiv = document.getElementById('exchangeMessage');
      msgDiv.innerHTML = '<div class="alert alert-info">üîÑ Fetching live exchange rates...</div>';

      try {
        // Fetch live rates from exchangerate-api.com (INR as base)
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/INR');
        const data = await response.json();

        if (!data.rates) throw new Error('Failed to fetch rates');

        // Get current config
        const { data: current } = await supabase
          .from('pricing_config')
          .select('config')
          .eq('id', 1)
          .single();

        const config = current?.config || {};
        
        // Update exchange rates
        config.exchangeRates = {
          INR: 1, // Base currency
          USD: data.rates.USD || 0.012,
          GBP: data.rates.GBP || 0.0095,
          EUR: data.rates.EUR || 0.011,
          CAD: data.rates.CAD || 0.016,
          AUD: data.rates.AUD || 0.018,
          NZD: data.rates.NZD || 0.020,
          SGD: data.rates.SGD || 0.016,
          MYR: data.rates.MYR || 0.055,
          AED: data.rates.AED || 0.044,
          SAR: data.rates.SAR || 0.045,
          JPY: data.rates.JPY || 1.78,
          CNY: data.rates.CNY || 0.087,
          BRL: data.rates.BRL || 0.060,
          MXN: data.rates.MXN || 0.20,
          ZAR: data.rates.ZAR || 0.22,
          CHF: data.rates.CHF || 0.011,
          SEK: data.rates.SEK || 0.125,
          NOK: data.rates.NOK || 0.126,
          DKK: data.rates.DKK || 0.082,
          PLN: data.rates.PLN || 0.048,
          TRY: data.rates.TRY || 0.38,
          RUB: data.rates.RUB || 1.10,
          KRW: data.rates.KRW || 15.88,
          THB: data.rates.THB || 0.42,
          IDR: data.rates.IDR || 187.5,
          PHP: data.rates.PHP || 0.67,
          VND: data.rates.VND || 294.5,
          BDT: data.rates.BDT || 1.32,
          PKR: data.rates.PKR || 3.34,
          LKR: data.rates.LKR || 3.91,
          NPR: data.rates.NPR || 1.59,
          HKD: data.rates.HKD || 0.094,
          TWD: data.rates.TWD || 0.38,
        };
        
        config.lastUpdated = new Date().toISOString();

        // Save to database
        const { error } = await supabase
          .from('pricing_config')
          .upsert({
            id: 1,
            config: config,
            updated_at: new Date().toISOString()
          });

        if (error) throw error;

        msgDiv.innerHTML = '<div class="alert alert-success">‚úÖ Exchange rates updated successfully!</div>';
        loadExchangeRates();
        setTimeout(() => msgDiv.innerHTML = '', 3000);
      } catch (error) {
        console.error('Error updating exchange rates:', error);
        msgDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}. Using cached rates.</div>`;
      }
    }

    async function loadUsers() {
      try {
        const { data: users } = await supabase
          .from('profiles')
          .select('id, email, is_book_owner, created_at')
          .order('created_at', { ascending: false });

        const table = `
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Book Owner</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${users?.map(u => `
                <tr>
                  <td>${u.email || 'N/A'}</td>
                  <td>${u.is_book_owner ? '‚úÖ Yes' : '‚ùå No'}</td>
                  <td>${new Date(u.created_at).toLocaleDateString()}</td>
                  <td>
                    <button class="btn btn-secondary" onclick="toggleBookOwner('${u.id}', ${!u.is_book_owner})">
                      ${u.is_book_owner ? 'Remove Books' : 'Grant Books'}
                    </button>
                  </td>
                </tr>
              `).join('') || '<tr><td colspan="4">No users found</td></tr>'}
            </tbody>
          </table>
        `;
        
        document.getElementById('usersTable').innerHTML = table;
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function toggleBookOwner(userId, newStatus) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ is_book_owner: newStatus })
          .eq('id', userId);

        if (error) throw error;
        
        alert('‚úÖ User updated successfully!');
        loadUsers();
      } catch (error) {
        console.error('Error updating user:', error);
        alert('‚ùå Error updating user');
      }
    }

    async function loadPurchases() {
      try {
        const { data: purchases } = await supabase
          .from('purchases')
          .select('*, profiles(email)')
          .eq('status', 'paid')
          .order('created_at', { ascending: false });

        const table = `
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>User</th>
                <th>Song</th>
                <th>Amount</th>
                <th>Provider</th>
              </tr>
            </thead>
            <tbody>
              ${purchases?.map(p => {
                const amount = (p.amount || 0) / 100;
                const currency = p.currency || 'INR';
                const symbol = currency === 'INR' ? '‚Çπ' : currency === 'USD' ? '$' : currency;
                
                return `
                  <tr>
                    <td>${new Date(p.created_at).toLocaleString()}</td>
                    <td>${p.profiles?.email || 'Unknown'}</td>
                    <td>${p.song_slug || p.song_id}</td>
                    <td>${symbol}${amount.toFixed(2)}</td>
                    <td>${p.provider || 'N/A'}</td>
                  </tr>
                `;
              }).join('') || '<tr><td colspan="5">No purchases found</td></tr>'}
            </tbody>
          </table>
        `;
        
        document.getElementById('purchasesTable').innerHTML = table;
      } catch (error) {
        console.error('Error loading purchases:', error);
      }
    }

    async function loadBundles() {
      try {
        const { data: bundles } = await supabase
          .from('purchases')
          .select('*, profiles(email)')
          .eq('status', 'paid')
          .eq('song_id', 'pack:5')
          .order('created_at', { ascending: false });

        const table = `
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>User</th>
                <th>Amount</th>
                <th>Credits Remaining</th>
                <th>Provider</th>
              </tr>
            </thead>
            <tbody>
              ${bundles?.map(b => {
                const amount = (b.amount || 0) / 100;
                const currency = b.currency || 'INR';
                const symbol = currency === 'INR' ? '‚Çπ' : currency === 'USD' ? '$' : currency;
                
                return `
                  <tr>
                    <td>${new Date(b.created_at).toLocaleString()}</td>
                    <td>${b.profiles?.email || 'Unknown'}</td>
                    <td>${symbol}${amount.toFixed(2)}</td>
                    <td>${b.credits_remaining ?? 5} / 5</td>
                    <td>${b.provider || 'N/A'}</td>
                  </tr>
                `;
              }).join('') || '<tr><td colspan="5">No bundle purchases found</td></tr>'}
            </tbody>
          </table>
        `;
        
        document.getElementById('bundlesTable').innerHTML = table;
      } catch (error) {
        console.error('Error loading bundles:', error);
      }
    }

    // Initial load
    loadOverview();
    loadPricing();
  </script>
</body>
</html>

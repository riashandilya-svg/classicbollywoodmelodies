<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Ria Om Shandilya</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #ffffff;
      --surface: rgba(255,255,255,0.82);
      --text: #1A1A1F;
      --muted: rgba(26,26,31,0.70);
      --border: rgba(140, 120, 160, 0.18);
      --shadow: 0 18px 44px rgba(22, 10, 35, 0.10);
      --primary: #9b6eff;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(255,120,160,0.28), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(155,110,255,0.26), transparent 62%),
        radial-gradient(780px 480px at 50% 80%, rgba(255,80,90,0.16), transparent 60%),
        var(--bg);
    }

    .banner {
      position: sticky;
      top: 0;
      z-index: 9999;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    .banner-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .banner-link {
      font-family: "Cormorant Garamond", serif;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: 0.7px;
      color: inherit;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 12px;
    }

    .admin-badge {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(251, 146, 60, 0.2));
      color: var(--error);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .banner-link:hover {
      text-decoration: underline;
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px 70px;
    }

    .header {
      margin-bottom: 32px;
    }

    h1 {
      font-size: clamp(32px, 4vw, 48px);
      line-height: 1.2;
      margin: 0 0 8px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 16px;
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 12px;
      background: white;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      color: var(--muted);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover {
      background: rgba(155, 110, 255, 0.05);
      border-color: var(--primary);
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(255,120,160,0.26), rgba(155,110,255,0.20));
      color: #2b1140;
      border-color: var(--primary);
    }

    .card {
      background: var(--surface);
      border-radius: 22px;
      padding: 32px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .refresh-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(155, 110, 255, 0.05);
      transform: translateY(-1px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-box {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 14px;
      margin: 4px 0 0;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: rgba(155, 110, 255, 0.08);
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: rgba(155, 110, 255, 0.02);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .badge-error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .delete-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--error);
      background: white;
      color: var(--error);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      transform: translateY(-1px);
    }
/* Manage Songs Button */
.manage-btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--primary);
  background: white;
  color: var(--primary);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s;
  margin-right: 8px;
}

.manage-btn:hover {
  background: rgba(155, 110, 255, 0.1);
  transform: translateY(-1px);
}

/* Song Management Modal Styles */
.song-list {
  margin: 20px 0;
}

.song-item {
  background: rgba(155, 110, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.song-item-info {
  flex: 1;
}

.song-item-id {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 4px;
}

.song-item-date {
  font-size: 13px;
  color: var(--muted);
}

.song-item-remove {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--error);
  background: white;
  color: var(--error);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s;
}

.song-item-remove:hover {
  background: rgba(239, 68, 68, 0.1);
}
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal {
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px;
      color: var(--error);
    }

    .modal-subtitle {
      color: var(--muted);
      font-size: 15px;
      margin: 0;
    }

    .warning-box {
      background: rgba(239, 68, 68, 0.08);
      border: 2px solid var(--error);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }

    .warning-box h3 {
      color: var(--error);
      font-size: 18px;
      margin: 0 0 12px;
    }

    .warning-box ul {
      margin: 0;
      padding-left: 20px;
      color: var(--text);
    }

    .warning-box li {
      margin: 8px 0;
      line-height: 1.5;
    }

    .confirmation-text {
      font-size: 16px;
      line-height: 1.6;
      margin: 20px 0;
    }

    .confirmation-step {
      background: rgba(155, 110, 255, 0.05);
      border-left: 3px solid var(--primary);
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 8px;
    }

    .step-number {
      font-weight: 700;
      color: var(--primary);
      font-size: 18px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 650;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-cancel:hover {
      background: rgba(155, 110, 255, 0.05);
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .search-box {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 20px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .code-display {
      font-family: 'Courier New', monospace;
      background: rgba(155, 110, 255, 0.05);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      color: var(--error);
    }

    .user-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .user-info .user-name {
      font-weight: 600;
      font-size: 14px;
    }
    .user-info .user-email {
      font-size: 12px;
      color: var(--muted);
    }

    .song-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .song-tag {
      background: rgba(155, 110, 255, 0.08);
      color: #5b2d8e;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
    }

    .photo-thumb {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.2s;
      background: #eee;
    }
    .photo-thumb:hover {
      transform: scale(1.08);
    }

    .video-play-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(155, 110, 255, 0.1);
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .video-play-btn:hover {
      background: rgba(155, 110, 255, 0.2);
      transform: translateY(-1px);
    }

    .media-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      z-index: 20000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      cursor: pointer;
    }
    .media-modal-overlay img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    }
    .media-modal-overlay video {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      background: #000;
    }

    th {
      user-select: none;
    }
    th[data-sortable] {
      cursor: pointer;
    }
    th[data-sortable]:hover {
      background: rgba(155, 110, 255, 0.14);
    }
    .sort-arrow {
      display: inline-block;
      margin-left: 6px;
      font-size: 11px;
      opacity: 0.35;
      transition: opacity 0.2s, transform 0.2s;
    }
    th[data-sortable].sort-asc .sort-arrow,
    th[data-sortable].sort-desc .sort-arrow {
      opacity: 1;
      color: var(--primary);
    }
    th[data-sortable].sort-desc .sort-arrow {
      transform: rotate(180deg);
    }

    .date-filter {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .date-filter select,
    .date-filter input {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      background: white;
      cursor: pointer;
    }

    .date-filter input {
      cursor: text;
    }

    .revenue-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
      border: 2px solid var(--success);
    }

    /* Live rates panel */
    .rates-panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .rates-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .rates-panel-header h3 {
      margin: 0;
      color: var(--primary);
    }
    .rates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .rate-chip {
      background: rgba(155, 110, 255, 0.06);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      text-align: center;
    }
    .rate-chip .rate-code {
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
    }
    .rate-chip .rate-val {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-top: 4px;
    }
    .rate-chip .rate-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    .rates-status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
    }
    .rates-status .live-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    @media (max-width: 768px) {
      .banner {
        flex-direction: column;
        height: auto;
        padding: 12px 16px;
        gap: 8px;
      }

      main {
        padding: 20px 16px;
      }

      .card {
        padding: 20px;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: 12px 8px;
      }

      .date-filter {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      background: rgba(155, 110, 255, 0.02);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 24px;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(155, 110, 255, 0.05);
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .pdf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .pdf-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s;
    }

    .pdf-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(155, 110, 255, 0.15);
    }

    .pdf-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .pdf-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .pdf-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }

    .pdf-actions button {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .pdf-actions button:hover {
      transform: translateY(-1px);
    }

    .btn-view {
      border-color: var(--primary) !important;
      color: var(--primary);
    }

    .btn-view:hover {
      background: rgba(155, 110, 255, 0.1);
    }

    .btn-delete {
      border-color: var(--error) !important;
      color: var(--error);
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.1);
    }

  </style>
</head>
<body>
  <header class="banner">
    <div class="banner-left">
      <a class="banner-link" href="https://riashandilya-svg.github.io/riaomshandilya/">Ria Om Shandilya</a>
      <span class="admin-badge">‚ö° ADMIN</span>
    </div>
    <button class="refresh-btn" onclick="location.reload()">‚Üª Refresh All</button>
  </header>

  <main>
    <div class="header">
      <h1>üéõÔ∏è Admin Dashboard</h1>
      <p class="subtitle">Manage users, track codes, and monitor purchases</p>
    </div>

    <div id="authCheck" class="loading">
      <div class="spinner"></div>
      <p>Verifying admin access...</p>
    </div>

    <div id="adminContent" class="hidden">
      <!-- Statistics Overview -->
      <div class="card">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-box">
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="bookOwners">-</div>
            <div class="stat-label">Book Owners</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="codesUsed">-</div>
            <div class="stat-label">Codes Used</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="codesLeft" style="color: var(--warning);">-</div>
            <div class="stat-label">Codes Left</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="totalPurchases">-</div>
            <div class="stat-label">Total Purchases</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="bundlesPurchased" style="color: var(--success);">-</div>
            <div class="stat-label">Bundles Sold</div>
          </div>
        </div>
      </div>

      <!-- Revenue Card -->
      <div class="card revenue-card" id="revenueCard">
        <div class="card-header">
          <h2 class="card-title">üí∞ Revenue Analytics</h2>
        </div>

        <div class="date-filter">
          <select id="revenuePeriod" onchange="updateRevenueDisplay()">
            <option value="today">Today</option>
            <option value="month" selected>This Month</option>
            <option value="90days">Last 90 Days</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
          <div id="customDateRange" class="hidden" style="display: flex; gap: 12px; align-items: center;">
            <input type="date" id="startDate" onchange="updateRevenueDisplay()">
            <span>to</span>
            <input type="date" id="endDate" onchange="updateRevenueDisplay()">
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="revenueINR" style="color: var(--success);">‚Çπ0</div>
            <div class="stat-label">Revenue (INR)</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="revenueTransactions">0</div>
            <div class="stat-label">Transactions</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('users', this)">üë• All Users</button>
        <button class="tab" onclick="switchTab('codes', this)">üé´ Book Codes</button>
        <button class="tab" onclick="switchTab('purchases', this)">üí≥ Purchases</button>
        <button class="tab" onclick="switchTab('bundles', this)">üì¶ Bundles</button>
          <button class="tab" onclick="switchTab('sheetmusic', this)">üìÑ Sheet Music</button>
        <button class="tab" onclick="switchTab('pricing', this)">üí∞ Pricing</button>
      </div>
      
      <!-- Users Tab -->
      <div id="usersTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üë• All Users</h2>
            <button class="refresh-btn" onclick="loadUsers()">‚Üª Refresh</button>
          </div>
          <input type="text" class="search-box" id="userSearch" placeholder="Search by name, email, or user ID..." onkeyup="filterUsers()">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th data-sortable data-col="name" data-table="users">Name & Email <span class="sort-arrow">‚ñ≤</span></th>
                  <th>Book Owner</th>
                  <th>Books Owned</th>
                  <th>Songs Purchased</th>
                  <th>Bundles</th>
                  <th>Photo</th>
                  <th>Video</th>
                  <th data-sortable data-col="joined" data-table="users" class="sort-desc">Joined <span class="sort-arrow">‚ñ≤</span></th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="9" class="loading">
                    <div class="spinner"></div>
                    Loading users...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Codes Tab -->
      <div id="codesTab" class="tab-content hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üé´ Book Verification Codes</h2>
            <button class="refresh-btn" onclick="loadCodes()">‚Üª Refresh</button>
          </div>
          <input type="text" class="search-box" id="codeSearch" placeholder="Search by code or book name..." onkeyup="filterCodes()">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Code</th>
                  <th data-sortable data-col="book" data-table="codes">Book <span class="sort-arrow">‚ñ≤</span></th>
                  <th>Status</th>
                  <th>Used By</th>
                  <th data-sortable data-col="generated" data-table="codes" class="sort-desc">Generated At <span class="sort-arrow">‚ñ≤</span></th>
                  <th data-sortable data-col="used" data-table="codes">Used At <span class="sort-arrow">‚ñ≤</span></th>
                </tr>
              </thead>
              <tbody id="codesTableBody">
                <tr>
                  <td colspan="6" class="loading">
                    <div class="spinner"></div>
                    Loading codes...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Purchases Tab -->
      <div id="purchasesTab" class="tab-content hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üí≥ All Purchases</h2>
            <button class="refresh-btn" onclick="loadPurchases()">‚Üª Refresh</button>
          </div>
          <input type="text" class="search-box" id="purchaseSearch" placeholder="Search by name, email, or song ID..." onkeyup="filterPurchases()">
          <div class="table-wrapper">
            <table>
            <thead>
            <tr>
              <th data-sortable data-col="name" data-table="purchases">Name & Email <span class="sort-arrow">‚ñ≤</span></th>
              <th data-sortable data-col="song" data-table="purchases">Song ID <span class="sort-arrow">‚ñ≤</span></th>
              <th data-sortable data-col="amount" data-table="purchases">Amount <span class="sort-arrow">‚ñ≤</span></th>
              <th>Credits Remaining</th>
              <th data-sortable data-col="date" data-table="purchases" class="sort-desc">Purchase Date <span class="sort-arrow">‚ñ≤</span></th>
              <th>Actions</th>
            </tr>
          </thead>
     <tbody id="purchasesTableBody">
  <tr>
    <td colspan="6" class="loading">
      <div class="spinner"></div>
      Loading purchases...
    </td>
  </tr>
</tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bundles Tab -->
      <div id="bundlesTab" class="tab-content hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üì¶ Bundle Credits Usage</h2>
            <button class="refresh-btn" onclick="loadBundles()">‚Üª Refresh</button>
          </div>
          <input type="text" class="search-box" id="bundleSearch" placeholder="Search by name or email..." onkeyup="filterBundles()">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th data-sortable data-col="name" data-table="bundles">Name & Email <span class="sort-arrow">‚ñ≤</span></th>
                  <th data-sortable data-col="bundlecount" data-table="bundles">Bundles Purchased <span class="sort-arrow">‚ñ≤</span></th>
                  <th data-sortable data-col="credits" data-table="bundles">Credits Remaining <span class="sort-arrow">‚ñ≤</span></th>
                  <th data-sortable data-col="date" data-table="bundles" class="sort-desc">Purchase Date <span class="sort-arrow">‚ñ≤</span></th>
                </tr>
              </thead>
              <tbody id="bundlesTableBody">
                <tr>
                  <td colspan="4" class="loading">
                    <div class="spinner"></div>
                    Loading bundles...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
  <!-- Sheet Music Tab -->
      <div id="sheetmusicTab" class="tab-content hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìÑ Sheet Music PDFs</h2>
            <button class="refresh-btn" onclick="loadSheetMusic()">‚Üª Refresh</button>
          </div>

          <div class="upload-area" onclick="document.getElementById('pdfUpload').click()">
            <input type="file" id="pdfUpload" accept=".pdf" multiple onchange="uploadPDFs(event)">
            <div style="font-size: 48px; margin-bottom: 12px;">üì§</div>
            <h3 style="margin: 0 0 8px;">Upload Sheet Music PDFs</h3>
            <p style="color: var(--muted); font-size: 14px; margin: 0;">
              Click to browse or drag PDFs here<br>
              <strong>Important:</strong> File name must match song slug (e.g., "kalho.pdf" for song:kalho)
            </p>
          </div>

          <div id="uploadProgress" class="hidden" style="background: rgba(155, 110, 255, 0.1); border: 1px solid var(--primary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 8px;" id="uploadStatus">Uploading...</div>
            <div style="background: white; height: 8px; border-radius: 4px; overflow: hidden;">
              <div id="uploadBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>

          <input type="text" class="search-box" id="pdfSearch" placeholder="Search PDFs..." onkeyup="filterPDFs()">

          <div id="pdfGrid" class="pdf-grid">
            <div class="loading">
              <div class="spinner"></div>
              Loading PDFs...
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing Tab -->
      <div id="pricingTab" class="tab-content hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üí∞ Global Pricing Management</h2>
            <button class="refresh-btn" onclick="loadPricingData()">‚Üª Refresh</button>
          </div>

          <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <h3 style="margin: 0 0 12px 0; color: var(--warning);">‚ö†Ô∏è Important Notes:</h3>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>Enter prices in <strong>normal amounts</strong> ‚Äî e.g. <strong>$8</strong> or <strong>‚Çπ150</strong></li>
              <li>Decimals are fine: $8.50, ‚Çπ149.99, etc.</li>
              <li>Changes apply immediately to all new purchases</li>
              <li>Existing purchases are not affected</li>
            </ul>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <!-- USD Pricing -->
            <div style="background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px;">
              <h3 style="margin: 0 0 20px 0; color: var(--primary);">üá∫üá∏ USD Pricing ($)</h3>
              
              <h4 style="margin: 16px 0 12px 0; font-size: 15px; color: var(--muted);">With Books:</h4>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">1st Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_books_first" class="search-box" style="margin: 0; padding-left:28px;" placeholder="8.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">2nd Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_books_second" class="search-box" style="margin: 0; padding-left:28px;" placeholder="7.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">3rd+ Songs</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_books_third" class="search-box" style="margin: 0; padding-left:28px;" placeholder="7.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Bundle (5 songs)</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_books_bundle" class="search-box" style="margin: 0; padding-left:28px;" placeholder="34.00">
                  </div>
                </div>
              </div>

              <h4 style="margin: 24px 0 12px 0; font-size: 15px; color: var(--muted);">Without Books:</h4>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">1st Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_nobooks_first" class="search-box" style="margin: 0; padding-left:28px;" placeholder="10.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">2nd Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_nobooks_second" class="search-box" style="margin: 0; padding-left:28px;" placeholder="9.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">3rd+ Songs</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_nobooks_third" class="search-box" style="margin: 0; padding-left:28px;" placeholder="8.00">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Bundle (5 songs)</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">$</span>
                    <input type="number" step="0.01" id="usd_nobooks_bundle" class="search-box" style="margin: 0; padding-left:28px;" placeholder="40.00">
                  </div>
                </div>
              </div>
            </div>

            <!-- INR Pricing -->
            <div style="background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px;">
              <h3 style="margin: 0 0 20px 0; color: var(--primary);">üáÆüá≥ INR Pricing (‚Çπ)</h3>
              
              <h4 style="margin: 16px 0 12px 0; font-size: 15px; color: var(--muted);">With Books:</h4>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">1st Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_books_first" class="search-box" style="margin: 0; padding-left:28px;" placeholder="150">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">2nd Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_books_second" class="search-box" style="margin: 0; padding-left:28px;" placeholder="129">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">3rd+ Songs</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_books_third" class="search-box" style="margin: 0; padding-left:28px;" placeholder="100">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Bundle (5 songs)</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_books_bundle" class="search-box" style="margin: 0; padding-left:28px;" placeholder="550">
                  </div>
                </div>
              </div>

              <h4 style="margin: 24px 0 12px 0; font-size: 15px; color: var(--muted);">Without Books:</h4>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">1st Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_nobooks_first" class="search-box" style="margin: 0; padding-left:28px;" placeholder="200">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">2nd Song</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_nobooks_second" class="search-box" style="margin: 0; padding-left:28px;" placeholder="180">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">3rd+ Songs</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_nobooks_third" class="search-box" style="margin: 0; padding-left:28px;" placeholder="150">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Bundle (5 songs)</label>
                  <div style="position:relative;">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);pointer-events:none;">‚Çπ</span>
                    <input type="number" step="0.01" id="inr_nobooks_bundle" class="search-box" style="margin: 0; padding-left:28px;" placeholder="850">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- AUTO Exchange Rates (read-only, live from Frankfurter) -->
          <div class="rates-panel" id="ratesPanel">
            <div class="rates-panel-header">
              <h3>üí± Live Exchange Rates (INR base)</h3>
              <button class="refresh-btn" onclick="fetchLiveRates()" style="font-size:13px; padding:8px 14px;">‚Üª Refresh Rates</button>
            </div>
            <p style="margin: 0 0 16px; font-size: 13px; color: var(--muted);">
              Auto-fetched from <strong>frankfurter.dev</strong> ‚Äî how much 1 INR is worth in each currency. Updates every time you open this tab.
            </p>
            <div id="ratesLoading" style="padding:20px; text-align:center; color:var(--muted);">
              <div class="spinner" style="width:28px;height:28px;border-width:2px;"></div>
              Fetching live rates...
            </div>
            <div id="ratesGridContainer" class="hidden">
              <div class="rates-grid" id="ratesGridEl"></div>
              <div class="rates-status" id="ratesStatus"></div>
            </div>
            <div id="ratesError" class="hidden" style="color:var(--error); font-size:13px; margin-top:8px;"></div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button class="btn btn-cancel" style="flex: 0 0 auto; padding: 14px 32px;" onclick="loadPricingData()">
              ‚Üª Reset Changes
            </button>
            <button class="btn btn-danger" style="flex: 1; background: var(--success);" onclick="savePricing()">
              üíæ Save All Pricing Changes
            </button>
          </div>

          <div id="pricingStatus" style="margin-top: 20px;"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- Delete User Modal -->
  <div id="deleteModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">‚ö†Ô∏è Delete User Account</h2>
        <p class="modal-subtitle">This action cannot be undone</p>
      </div>

      <div id="confirmStep1" class="confirmation-step">
        <p class="step-number">Step 1 of 3</p>
        <p class="confirmation-text">
          You are about to permanently delete the user: <strong id="deleteUserName"></strong>
          <br>Email: <span class="code-display" id="deleteUserEmail"></span>
        </p>
        <div class="warning-box">
          <h3>‚ö†Ô∏è This will permanently delete:</h3>
          <ul>
            <li>User profile data</li>
            <li>All purchase history</li>
            <li>All song downloads</li>
            <li>Book verification status</li>
            <li>Credit balances</li>
          </ul>
        </div>
        <div class="modal-actions">
          <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmStep2()">Continue to Step 2</button>
        </div>
      </div>

      <div id="confirmStep2" class="confirmation-step hidden">
        <p class="step-number">Step 2 of 3</p>
        <p class="confirmation-text">
          Are you absolutely sure you want to delete this user?<br>
          <strong>This will erase all their data permanently.</strong>
        </p>
        <div class="modal-actions">
          <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmStep3()">Yes, Continue to Step 3</button>
        </div>
      </div>

      <div id="confirmStep3" class="confirmation-step hidden">
        <p class="step-number">Step 3 of 3 - FINAL CONFIRMATION</p>
        <p class="confirmation-text">
          <strong style="color: var(--error); font-size: 18px;">LAST CHANCE TO CANCEL!</strong><br><br>
          This is your final warning. Once you click "DELETE FOREVER", the user and all their data will be permanently erased from the database.
        </p>
        <div class="modal-actions">
          <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel - Don't Delete</button>
          <button class="btn btn-danger" id="finalDeleteBtn" onclick="deleteUserForever()">DELETE FOREVER</button>
        </div>
      </div>

      <div id="deletingStep" class="confirmation-step hidden">
        <div class="loading">
          <div class="spinner"></div>
          <p>Deleting user and all associated data...</p>
        </div>
      </div>
    </div>
  </div>
<!-- Manage Songs Modal -->
<div id="manageSongsModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" style="color: var(--primary);">üéµ Manage Song Access</h2>
      <p class="modal-subtitle" id="manageSongsUserName"></p>
    </div>

    <div id="songsList" class="song-list">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading songs...</p>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closeManageSongsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Remove Song Confirmation Modal -->
<div id="removeSongModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">‚ö†Ô∏è Remove Song Access</h2>
      <p class="modal-subtitle">This action cannot be undone</p>
    </div>

    <div id="removeSongStep1" class="confirmation-step">
      <p class="step-number">Step 1 of 3</p>
      <p class="confirmation-text">
        You are about to remove song access for:<br>
        <strong id="removeSongUserDisplay"></strong><br>
        <br>
        Song ID: <span class="code-display" id="removeSongId"></span>
      </p>
      <div class="warning-box">
        <h3>‚ö†Ô∏è This will:</h3>
        <ul>
          <li>Remove the song from their purchased songs list</li>
          <li>Revoke their download access</li>
          <li>Delete their entitlement for this song</li>
          <li><strong>NOT refund any payment</strong></li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeRemoveSongModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmRemoveSongStep2()">Continue to Step 2</button>
      </div>
    </div>

    <div id="removeSongStep2" class="confirmation-step hidden">
      <p class="step-number">Step 2 of 3</p>
      <p class="confirmation-text">
        Are you absolutely sure you want to remove this song access?<br>
        <strong>The user will no longer be able to download or access this song.</strong>
      </p>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeRemoveSongModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmRemoveSongStep3()">Yes, Continue to Step 3</button>
      </div>
    </div>

    <div id="removeSongStep3" class="confirmation-step hidden">
      <p class="step-number">Step 3 of 3 - FINAL CONFIRMATION</p>
      <p class="confirmation-text">
        <strong style="color: var(--error); font-size: 18px;">LAST CHANCE TO CANCEL!</strong><br><br>
        Once you click "REMOVE ACCESS", the user will permanently lose access to this song.
      </p>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeRemoveSongModal()">Cancel - Don't Remove</button>
        <button class="btn btn-danger" onclick="removeSongAccessForever()">REMOVE ACCESS</button>
      </div>
    </div>

    <div id="removingSongStep" class="confirmation-step hidden">
      <div class="loading">
        <div class="spinner"></div>
        <p>Removing song access...</p>
      </div>
    </div>
  </div>
</div>
  <!-- Media Lightbox Modal (photo + video) -->
  <div id="mediaModal" class="media-modal-overlay hidden" onclick="closeMediaModal()">
    <img id="mediaModalImg" src="" alt="Book verification photo" style="display:none;">
    <video id="mediaModalVideo" controls autoplay style="display:none;" onclick="event.stopPropagation()"></video>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://lyqpxcilniqzurevetae.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cXB4Y2lsbmlxenVyZXZldGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDAyMTQsImV4cCI6MjA4NTExNjIxNH0.40ZbAatkMBFHacQGCpiNYpjcKQoZik-Xvqx3bG46x7c";
    
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_EMAILS = ["riaomshandilya@gmail.com", "riashandilya@gmail.com"];

   let allUsers = [];
let allCodes = [];
let allPurchases = [];
let allBundles = [];
let userToDelete = null;
let allPDFs = [];
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SHEET MUSIC MANAGEMENT  (all calls routed through admin-edge)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // üëâ This is your edge function URL ‚Äî constructed from SUPABASE_URL so it stays in sync.
const ADMIN_EDGE_URL = `${SUPABASE_URL}/functions/v1/admin-list-pdfs`;

    // Generic helper: calls admin-edge with the given action.
    // body can be: null (GET), a plain object (sent as JSON), or a FormData (sent as multipart for uploads).
    async function edgeRequest(action, body = null) {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      const url = `${ADMIN_EDGE_URL}?action=${action}`;

      const options = {
        method: body ? "POST" : "GET",
        headers: {
          "Authorization": `Bearer ${session.access_token}`,
        },
      };

      if (body instanceof FormData) {
        // Upload: let the browser set Content-Type with the multipart boundary
        options.body = body;
      } else if (body) {
        options.headers["Content-Type"] = "application/json";
        options.body = JSON.stringify(body);
      }

      const res = await fetch(url, options);
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
        throw new Error(err.error || `HTTP ${res.status}`);
      }
      return res.json();
    }

    async function loadSheetMusic() {
      const grid = document.getElementById('pdfGrid');
      grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading PDFs...</div>';

      try {
        const result = await edgeRequest("list");
        allPDFs = result.files || [];

        if (allPDFs.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÑ</div>
              <p>No PDF files found</p>
              <p style="font-size: 13px; color: var(--muted);">Upload PDFs using the area above</p>
            </div>`;
          return;
        }

        renderPDFs(allPDFs);
      } catch (e) {
        console.error('üí• Error loading PDFs:', e);
        grid.innerHTML = `<div class="error-message">Error loading PDFs: ${e.message}</div>`;
      }
    }

    function renderPDFs(pdfs) {
      const grid = document.getElementById('pdfGrid');
      
      if (!pdfs.length) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <p>No PDFs uploaded yet</p>
          </div>`;
        return;
      }

      grid.innerHTML = pdfs.map(pdf => `
        <div class="pdf-item">
          <div class="pdf-icon">üìÑ</div>
          <div class="pdf-name">${pdf.name}</div>
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
            ${pdf.metadata && pdf.metadata.size ? (pdf.metadata.size / 1024).toFixed(1) + ' KB' : 'Unknown size'}
          </div>
          <div class="pdf-actions">
            <button class="btn-view" onclick="viewPDF('${pdf.name}')">üëÅÔ∏è View</button>
            <button class="btn-delete" onclick="deletePDF('${pdf.name}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    function filterPDFs() {
      const search = document.getElementById('pdfSearch').value.toLowerCase();
      const filtered = allPDFs.filter(pdf => 
        pdf.name.toLowerCase().includes(search)
      );
      renderPDFs(filtered);
    }

    async function viewPDF(filename) {
      try {
        const result = await edgeRequest("view", { filename });
        window.open(result.url, '_blank');
      } catch (e) {
        alert('‚ùå Error viewing PDF: ' + e.message);
      }
    }

    async function deletePDF(filename) {
      if (!confirm(`Delete "${filename}"?\n\nThis will remove the PDF from storage. Users who purchased this song will no longer be able to download it.`)) {
        return;
      }

      try {
        await edgeRequest("delete", { filename });
        alert('‚úÖ PDF deleted successfully!');
        await loadSheetMusic();
      } catch (e) {
        alert('‚ùå Error deleting PDF: ' + e.message);
      }
    }

    async function uploadPDFs(event) {
      const files = Array.from(event.target.files);
      if (!files.length) return;

      const progress = document.getElementById('uploadProgress');
      const status = document.getElementById('uploadStatus');
      const bar = document.getElementById('uploadBar');

      progress.classList.remove('hidden');
      
      let uploaded = 0;
      const total = files.length;

      for (const file of files) {
        if (!file.name.endsWith('.pdf')) {
          alert(`‚ö†Ô∏è Skipping "${file.name}" - not a PDF file`);
          continue;
        }

        try {
          status.textContent = `Uploading ${uploaded + 1}/${total}: ${file.name}`;
          bar.style.width = `${(uploaded / total) * 100}%`;

          // Send as multipart FormData so the edge function receives the actual file bytes
          const formData = new FormData();
          formData.append("file", file);
          formData.append("filename", file.name);

          await edgeRequest("upload", formData);
          uploaded++;
        } catch (e) {
          alert(`‚ùå Error uploading "${file.name}": ${e.message}`);
        }
      }

      bar.style.width = '100%';
      status.textContent = `‚úÖ Uploaded ${uploaded}/${total} files!`;

      setTimeout(() => {
        progress.classList.add('hidden');
        bar.style.width = '0%';
        event.target.value = '';
      }, 2000);

      await loadSheetMusic();
    }

    // ‚îÄ‚îÄ Live rates fetched from frankfurter (stored here so savePricing can use them) ‚îÄ‚îÄ
    let liveExchangeRates = null; // will be { USD: 0.012, GBP: 0.0095, ... } keyed as "1 INR = X currency"

    // ‚îÄ‚îÄ Saved exchange rates loaded from pricing_config on init ‚îÄ‚îÄ
    // Format from DB: { USD: 1, INR: 83.5, GBP: 0.79, ... } meaning "1 USD = X currency"
    let savedExchangeRates = null;

    // Currency symbols for display
    const CURRENCY_SYMBOLS = {
      'INR': '‚Çπ', 'USD': '$', 'GBP': '¬£', 'EUR': '‚Ç¨',
      'CAD': 'CA$', 'AUD': 'A$', 'JPY': '¬•',
    };

    // Which currencies we show in the admin live-rates panel
    const RATE_CURRENCIES = ['USD','GBP','EUR','CAD','AUD','JPY'];

    // Convert any amount (in smallest unit) from currency X ‚Üí INR (paise)
    // DB exchangeRates format: { USD: 1, INR: 83.5, GBP: 0.79 } = "1 USD = X currency"
    // So: amount_in_INR = amount_in_C  *  (rates.INR / rates.C)
    function convertToINR(amount, currency) {
      if (!amount) return 0;
      if (!currency || currency === 'INR') return amount;
      if (!savedExchangeRates || !savedExchangeRates.INR) {
        // Fallback hardcoded rates if DB hasn't loaded yet
        const fallback = { USD: 1, INR: 84, GBP: 0.79, EUR: 0.92, CAD: 1.35, AUD: 1.52, JPY: 148 };
        const rateC = fallback[currency];
        if (!rateC) return amount; // unknown currency, return as-is
        return Math.round(amount * (fallback.INR / rateC));
      }
      const rateC = savedExchangeRates[currency];
      if (!rateC) return amount; // unknown currency, return as-is
      return Math.round(amount * (savedExchangeRates.INR / rateC));
    }

    function formatAmount(amount, currency = 'INR') {
      if (!amount) return 'N/A';
      const symbol = CURRENCY_SYMBOLS[currency] || currency;
      const noDecimals = ['JPY', 'KRW', 'VND', 'IDR'];
      if (noDecimals.includes(currency)) {
        return `${symbol}${(amount / 100).toFixed(0)}`;
      }
      return `${symbol}${(amount / 100).toFixed(2)}`;
    }

    function userInfoHTML(name, email) {
      return `<div class="user-info">
                <span class="user-name">${name || 'N/A'}</span>
                <span class="user-email">${email || 'N/A'}</span>
              </div>`;
    }

    function getProfile(userId) {
      return allUsers.find(u => u.id === userId);
    }

    function getSongsForUser(userId) {
      return allPurchases
        .filter(p => p.user_id === userId && p.song_id !== 'pack:5')
        .map(p => p.song_id);
    }

    function getBundleCountForUser(userId) {
      return allBundles.filter(b => b.user_id === userId).length;
    }

    async function getPhotoUrl(userId) {
      try {
        const { data: files, error } = await window.supabase.storage
          .from('book-verifications').list(userId);
        if (error || !files || files.length === 0) return null;
        const { data, error: signErr } = await window.supabase.storage
          .from('book-verifications').createSignedUrl(`${userId}/${files[0].name}`, 3600);
        if (signErr || !data) return null;
        return data.signedUrl;
      } catch (e) { return null; }
    }

    async function getVideoUrl(userId) {
      try {
        const { data: files, error } = await window.supabase.storage
          .from('book-videos').list(userId);
        if (error || !files || files.length === 0) return null;
        const { data, error: signErr } = await window.supabase.storage
          .from('book-videos').createSignedUrl(`${userId}/${files[0].name}`, 3600);
        if (signErr || !data) return null;
        return data.signedUrl;
      } catch (e) { return null; }
    }

    let photoCache = {};
    let videoCache = {};

    async function fetchMediaForUser(userId) {
      if (!(userId in photoCache)) photoCache[userId] = await getPhotoUrl(userId);
      if (!(userId in videoCache)) videoCache[userId] = await getVideoUrl(userId);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FRANKFURTER LIVE RATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Frankfurter default base is EUR. We want INR as base.
    // Frankfurter supports ?base=INR so we get "1 INR = X currency" directly.

    async function fetchLiveRates() {
      const loading = document.getElementById('ratesLoading');
      const container = document.getElementById('ratesGridContainer');
      const errEl = document.getElementById('ratesError');
      const gridEl = document.getElementById('ratesGridEl');
      const statusEl = document.getElementById('ratesStatus');

      loading.style.display = 'block';
      container.classList.add('hidden');
      errEl.classList.add('hidden');
      errEl.textContent = '';

      try {
        const symbols = RATE_CURRENCIES.join(',');
        const res = await fetch(`https://api.frankfurter.dev/v1/latest?base=INR&symbols=${symbols}`);
        if (!res.ok) throw new Error(`Frankfurter returned ${res.status}`);
        const json = await res.json();
        // json.rates = { USD: 0.01183, GBP: 0.00934, ... }  ‚Äî these are "1 INR = X currency"
        liveExchangeRates = json.rates; // store globally for save

        // Render chips
        gridEl.innerHTML = RATE_CURRENCIES.map(code => {
          const val = json.rates[code];
          if (val == null) return '';
          // Show a few decimals depending on magnitude
          const decimals = val < 0.01 ? 6 : val < 1 ? 4 : val >= 100 ? 1 : 3;
          const display = val.toFixed(decimals);
          // Also show inverse: 1 USD = ? INR
          const inverse = (1 / val).toFixed(2);
          return `<div class="rate-chip">
            <div class="rate-code">${code}</div>
            <div class="rate-val">${display}</div>
            <div class="rate-label">1 INR = ${display} ${code}<br>1 ${code} = ‚Çπ${inverse}</div>
          </div>`;
        }).join('');

        loading.style.display = 'none';
        container.classList.remove('hidden');
        statusEl.innerHTML = `<span class="live-dot"></span>Live rates as of <strong>${json.date}</strong> ‚Äî auto-fetched from frankfurter.dev`;

      } catch (e) {
        loading.style.display = 'none';
        errEl.classList.remove('hidden');
        errEl.textContent = '‚ùå Failed to fetch rates: ' + e.message + ' ‚Äî will use last saved rates on save.';
        liveExchangeRates = null;
      }
    }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGE SONGS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentManageUser = null;
let songToRemove = null;

function openManageSongsModal(user) {
  currentManageUser = user;
  document.getElementById('manageSongsUserName').textContent = 
    `${user.display_name || 'User'} (${user.email})`;
  
  document.getElementById('manageSongsModal').classList.remove('hidden');
  loadUserSongs(user.id);
}

function loadUserSongs(userId) {
  const songsList = document.getElementById('songsList');
  songsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading songs...</p></div>';

  const userSongs = allPurchases.filter(p => 
    p.user_id === userId && p.song_id !== 'pack:5'
  );

  if (userSongs.length === 0) {
    songsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üéµ</div>
        <p>No songs purchased</p>
      </div>`;
    return;
  }

  songsList.innerHTML = userSongs.map(purchase => `
    <div class="song-item">
      <div class="song-item-info">
        <div class="song-item-id">${purchase.song_id}</div>
        <div class="song-item-date">Purchased: ${new Date(purchase.created_at).toLocaleDateString()}</div>
      </div>
      <button class="song-item-remove" onclick="openRemoveSongModal('${purchase.song_id}')">
        üóëÔ∏è Remove Access
      </button>
    </div>
  `).join('');
}

function closeManageSongsModal() {
  document.getElementById('manageSongsModal').classList.add('hidden');
  currentManageUser = null;
  // Don't call loadUsers() here - just refresh the current tab if needed
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMOVE SONG CONFIRMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openRemoveSongModal(songId) {
  if (!currentManageUser) return;
  
  songToRemove = { userId: currentManageUser.id, songId };
  
  document.getElementById('removeSongUserDisplay').textContent = 
    `${currentManageUser.display_name || 'User'} (${currentManageUser.email})`;
  document.getElementById('removeSongId').textContent = songId;

  document.getElementById('removeSongStep1').classList.remove('hidden');
  document.getElementById('removeSongStep2').classList.add('hidden');
  document.getElementById('removeSongStep3').classList.add('hidden');
  document.getElementById('removingSongStep').classList.add('hidden');
  
  document.getElementById('removeSongModal').classList.remove('hidden');
}

function confirmRemoveSongStep2() {
  document.getElementById('removeSongStep1').classList.add('hidden');
  document.getElementById('removeSongStep2').classList.remove('hidden');
}

function confirmRemoveSongStep3() {
  document.getElementById('removeSongStep2').classList.add('hidden');
  document.getElementById('removeSongStep3').classList.remove('hidden');
}

function closeRemoveSongModal() {
  document.getElementById('removeSongModal').classList.add('hidden');
  songToRemove = null;
}

async function removeSongAccessForever() {
  if (!songToRemove) return;

  document.getElementById('removeSongStep3').classList.add('hidden');
  document.getElementById('removingSongStep').classList.remove('hidden');

  try {
    const { data: { session } } = await window.supabase.auth.getSession();
    
    if (!session || !session.user) {
      throw new Error('Not authenticated');
    }

    console.log('Calling remove_song_access:', {
      userId: songToRemove.userId,
      songId: songToRemove.songId,
      email: session.user.email
    });

    const { data, error } = await window.supabase.rpc('remove_song_access', {
      p_user_id: songToRemove.userId,
      p_song_id: songToRemove.songId,
      p_admin_email: session.user.email
    });

    console.log('Response:', { data, error });

    if (error) {
      console.error('Supabase error:', error);
      throw new Error(error.message);
    }
    
    if (data && data.error) {
      throw new Error(data.error);
    }

    alert(`‚úÖ Song access removed successfully!\n\nSong: ${songToRemove.songId}\nUser: ${currentManageUser.email}`);
    
    closeRemoveSongModal();
    
    await Promise.all([loadPurchasesData(), loadBundlesData()]);
    loadUserSongs(currentManageUser.id);
    calculateRevenue();
    
  } catch (e) {
    console.error('Remove song error:', e);
    alert('‚ùå Error: ' + e.message);
    
    document.getElementById('removingSongStep').classList.add('hidden');
    document.getElementById('removeSongStep3').classList.remove('hidden');
  }
}
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTH + INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function checkAdminAccess() {
      try {
        const { data: { session }, error } = await window.supabase.auth.getSession();
        const authCheck = document.getElementById('authCheck');
        const adminContent = document.getElementById('adminContent');

        if (error || !session) {
          authCheck.innerHTML = '<p style="color: var(--error); font-size: 18px;">Access Denied: Not logged in</p>';
          return;
        }

        if (!ADMIN_EMAILS.includes(session.user.email)) {
          authCheck.innerHTML = '<p style="color: var(--error); font-size: 18px;">‚õî Access Denied: You are not an admin</p>';
          return;
        }

        authCheck.classList.add('hidden');
        adminContent.classList.remove('hidden');

        await Promise.all([loadPurchasesData(), loadBundlesData(), loadSavedRates()]);
        loadStats();
        loadUsers();
        loadCodes();
        updateRevenueDisplay();
        updateSortHeaders('purchases');
        renderPurchases(sortArray(allPurchases, 'purchases'));
        updateSortHeaders('bundles');
        renderBundles(sortArray(allBundles, 'bundles'));
        initSortHeaders();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('authCheck').innerHTML = '<p style="color: var(--error);">An error occurred</p>';
      }
    }

    async function loadStats() {
      try {
        const { data: allProfiles } = await window.supabase.from('profiles').select('id, email, is_book_owner');
        const nonAdmin = allProfiles?.filter(p => !ADMIN_EMAILS.includes(p.email)) || [];
        document.getElementById('totalUsers').textContent = nonAdmin.length;
        document.getElementById('bookOwners').textContent = nonAdmin.filter(p => p.is_book_owner).length;

        const { count: totalCodes } = await window.supabase
          .from('book_verification_codes').select('*', { count: 'exact', head: true });
        const { count: codesUsed } = await window.supabase
          .from('book_verification_codes').select('*', { count: 'exact', head: true }).eq('is_used', true);
        const usedCount = codesUsed || 0;
        const leftCount = (totalCodes || 0) - usedCount;
        document.getElementById('codesUsed').textContent = usedCount;
        document.getElementById('codesLeft').textContent = leftCount;
        document.getElementById('codesLeft').style.color = leftCount <= 2 ? 'var(--error)' : 'var(--warning)';

        const adminIds = allProfiles?.filter(p => ADMIN_EMAILS.includes(p.email)).map(p => p.id) || [];
        const nonAdminPurchases = allPurchases?.filter(p => !adminIds.includes(p.user_id)) || [];
        document.getElementById('totalPurchases').textContent = nonAdminPurchases.length;

        const bundlesSold = allBundles?.filter(b => !adminIds.includes(b.user_id)).length || 0;
        document.getElementById('bundlesPurchased').textContent = bundlesSold;
      } catch (e) { console.error('Stats error:', e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REVENUE ‚Äî period filter (today / month / 90d / year / custom), all in INR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function updateRevenueDisplay() {
      const period = document.getElementById('revenuePeriod').value;
      const customRange = document.getElementById('customDateRange');
      if (period === 'custom') {
        customRange.classList.remove('hidden');
      } else {
        customRange.classList.add('hidden');
      }
      calculateRevenue();
    }

    function calculateRevenue() {
      const period = document.getElementById('revenuePeriod').value;
      const now = new Date();
      let startDate, endDate;

      if (period === 'today') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        endDate   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
      } else if (period === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = now;
      } else if (period === '90days') {
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 90);
        endDate = now;
      } else if (period === 'year') {
        startDate = new Date(now.getFullYear(), 0, 1);
        endDate = now;
      } else if (period === 'custom') {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return;
        startDate = new Date(start);
        endDate = new Date(end);
        endDate.setHours(23, 59, 59, 999);
      }

      const filtered = allPurchases.filter(p => {
        const date = new Date(p.created_at);
        return date >= startDate && date <= endDate;
      });

      let totalINR = 0;
      filtered.forEach(p => {
        totalINR += convertToINR(p.amount || 0, p.currency || 'INR');
      });

      document.getElementById('revenueINR').textContent = formatAmount(totalINR, 'INR');
      document.getElementById('revenueTransactions').textContent = filtered.length;
    }

    // Load saved exchange rates from pricing_config so convertToINR works
    async function loadSavedRates() {
      try {
        const { data, error } = await window.supabase
          .from('pricing_config').select('config').eq('id', 1).single();
        if (!error && data?.config?.exchangeRates) {
          savedExchangeRates = data.config.exchangeRates;
        }
      } catch (e) { console.warn('Could not load saved rates:', e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // USERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadUsers() {
      try {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div>Loading users...</td></tr>';

        const { data: profiles, error } = await window.supabase
          .from('profiles').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        allUsers = profiles || [];

        await Promise.all(allUsers.map(u => fetchMediaForUser(u.id)));
        updateSortHeaders('users');
        renderUsers(sortArray(allUsers, 'users'));
      } catch (e) {
        console.error('Error loading users:', e);
        document.getElementById('usersTableBody').innerHTML =
          `<tr><td colspan="9"><div class="error-message">Error: ${e.message}</div></td></tr>`;
      }
    }

    function renderUsers(list) {
      const tbody = document.getElementById('usersTableBody');
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üì≠</div><p>No users found</p></td></tr>';
        return;
      }

      tbody.innerHTML = list.map(user => {
        const isAdmin = ADMIN_EMAILS.includes(user.email);
        const songs = getSongsForUser(user.id);
        const bundleCount = getBundleCountForUser(user.id);
        const photoUrl = photoCache[user.id] || null;
        const videoUrl = videoCache[user.id] || null;

        const songsHTML = songs.length
          ? `<div class="song-tags">${songs.map(s => `<span class="song-tag">${s}</span>`).join('')}</div>`
          : '<span style="color: var(--muted); font-size: 13px;">None</span>';

        const photoHTML = photoUrl
          ? `<img class="photo-thumb" src="${photoUrl}" alt="Book photo" onclick="openMediaModal('photo','${photoUrl}')">`
          : '<span style="color: var(--muted); font-size: 13px;">None</span>';

        const videoHTML = videoUrl
          ? `<button class="video-play-btn" onclick="openMediaModal('video','${videoUrl}')">‚ñ∂ Play</button>`
          : '<span style="color: var(--muted); font-size: 13px;">None</span>';

    const actionButtons = isAdmin
  ? '<span class="badge badge-warning">ADMIN</span>'
  : songs.length > 0
    ? `<button class="manage-btn" onclick='openManageSongsModal(${JSON.stringify(user).replace(/'/g, "&#39;")})'>üéµ Manage Songs</button>
       <button class="delete-btn" onclick='openDeleteModal(${JSON.stringify(user).replace(/'/g, "&#39;")})'>üóëÔ∏è Delete</button>`
    : `<button class="delete-btn" onclick='openDeleteModal(${JSON.stringify(user).replace(/'/g, "&#39;")})'>üóëÔ∏è Delete</button>`;
        
        return `<tr>
          <td>${userInfoHTML(user.display_name, user.email)}</td>
          <td>${user.is_book_owner ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-error">No</span>'}</td>
          <td>${user.books_owned && user.books_owned.length ? user.books_owned.join(', ') : 'None'}</td>
          <td>${songsHTML}</td>
          <td>${bundleCount > 0 ? `<span class="badge badge-success">${bundleCount}</span>` : '<span class="badge badge-error">0</span>'}</td>
          <td>${photoHTML}</td>
          <td>${videoHTML}</td>
          <td>${new Date(user.created_at).toLocaleDateString()}</td>
<td>${actionButtons}</td>
        </tr>`;
      }).join('');
    }

    function filterUsers() {
      const q = document.getElementById('userSearch').value.toLowerCase();
      const filtered = allUsers.filter(u =>
        (u.display_name?.toLowerCase().includes(q)) ||
        (u.email?.toLowerCase().includes(q)) ||
        (u.id?.toLowerCase().includes(q))
      );
      if (!filtered.length) {
        document.getElementById('usersTableBody').innerHTML =
          '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üîç</div><p>No users match your search</p></td></tr>';
        return;
      }
      renderUsers(filtered);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CODES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadCodes() {
      try {
        const tbody = document.getElementById('codesTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading codes...</td></tr>';

        const { data: codes, error } = await window.supabase
          .from('book_verification_codes').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        allCodes = codes || [];
        updateSortHeaders('codes');
        renderCodes(sortArray(allCodes, 'codes'));
      } catch (e) {
        console.error('Error loading codes:', e);
        document.getElementById('codesTableBody').innerHTML =
          `<tr><td colspan="6"><div class="error-message">Error: ${e.message}</div></td></tr>`;
      }
    }

    function renderCodes(list) {
      const tbody = document.getElementById('codesTableBody');
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üé´</div><p>No codes found</p></td></tr>';
        return;
      }
      const bookNames = { soulful:'Soulful', peppy:'Peppy', romantic:'Romantic', classic:'Classic' };

      tbody.innerHTML = list.map(code => {
        const profile = code.used_by_user_id ? getProfile(code.used_by_user_id) : null;
        const usedByHTML = profile
          ? userInfoHTML(profile.display_name, profile.email)
          : (code.used_by_user_id ? `<span class="code-display">${code.used_by_user_id.substring(0,8)}...</span>` : '-');

        return `<tr>
          <td><span class="code-display">${code.code}</span></td>
          <td>${bookNames[code.book_name] || code.book_name}</td>
          <td>${code.is_used ? '<span class="badge badge-success">Used</span>' : '<span class="badge badge-warning">Unused</span>'}</td>
          <td>${usedByHTML}</td>
          <td>${new Date(code.created_at).toLocaleString()}</td>
          <td>${code.used_at ? new Date(code.used_at).toLocaleString() : '-'}</td>
        </tr>`;
      }).join('');
    }

    function filterCodes() {
      const q = document.getElementById('codeSearch').value.toLowerCase();
      const filtered = allCodes.filter(c =>
        c.code.toLowerCase().includes(q) || c.book_name.toLowerCase().includes(q)
      );
      if (!filtered.length) {
        document.getElementById('codesTableBody').innerHTML =
          '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üîç</div><p>No codes match your search</p></td></tr>';
        return;
      }
      renderCodes(filtered);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PURCHASES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function loadPurchasesData() {
      const { data, error } = await window.supabase
        .from('purchases').select('*').order('created_at', { ascending: false });
      if (error) throw error;
      allPurchases = data || [];
    }
    
    async function loadPurchases() {
      try {
        document.getElementById('purchasesTableBody').innerHTML =
          '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading purchases...</td></tr>';
        await loadPurchasesData();
        updateSortHeaders('purchases');
        renderPurchases(sortArray(allPurchases, 'purchases'));
        calculateRevenue();
      } catch (e) {
        console.error('Error:', e);
        document.getElementById('purchasesTableBody').innerHTML =
          `<tr><td colspan="6"><div class="error-message">Error: ${e.message}</div></td></tr>`;
      }
    }
    
function renderPurchases(list) {
  const data = list || allPurchases;
  const tbody = document.getElementById('purchasesTableBody');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üí≥</div><p>No purchases found</p></td></tr>';
    return;
  }
  tbody.innerHTML = data.map(p => {
    const profile = getProfile(p.user_id);
    const amountINR = convertToINR(p.amount || 0, p.currency || 'INR');
    const origCurrency = p.currency || 'INR';
    const convertedLabel = origCurrency !== 'INR' ? ` <span style="font-size:11px;color:var(--muted);">(was ${CURRENCY_SYMBOLS[origCurrency] || origCurrency}${origCurrency === 'JPY' ? (p.amount/100).toFixed(0) : (p.amount/100).toFixed(2)})</span>` : '';
    
    const userSongs = getSongsForUser(p.user_id);
    const isAdmin = ADMIN_EMAILS.includes(profile?.email);
    
    // Only show manage button if profile exists, user is not admin, and has songs
    let manageButton = '';
    if (profile && !isAdmin && userSongs.length > 0) {
      const profileJson = JSON.stringify(profile).replace(/'/g, "&#39;");
      manageButton = `<button class="manage-btn" onclick='openManageSongsModal(${profileJson})' style="padding: 6px 12px; font-size: 12px;">üéµ Manage</button>`;
    }
    
    return `<tr>
      <td>${userInfoHTML(profile?.display_name, profile?.email)}</td>
      <td><span class="code-display">${p.song_id}</span></td>
      <td>${formatAmount(amountINR, 'INR')}${convertedLabel}</td>
      <td>${p.credits_remaining !== null && p.credits_remaining !== undefined ? p.credits_remaining : 'N/A'}</td>
      <td>${new Date(p.created_at).toLocaleString()}</td>
      <td>${manageButton}</td>
    </tr>`;
  }).join('');
}
    
    function filterPurchases() {
      const q = document.getElementById('purchaseSearch').value.toLowerCase();
      const filtered = allPurchases.filter(p => {
        const profile = getProfile(p.user_id);
        return (
          p.user_id.toLowerCase().includes(q) ||
          p.song_id.toLowerCase().includes(q) ||
          (profile?.display_name?.toLowerCase().includes(q)) ||
          (profile?.email?.toLowerCase().includes(q))
        );
      });
      if (!filtered.length) {
        document.getElementById('purchasesTableBody').innerHTML =
          '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üîç</div><p>No purchases match your search</p></td></tr>';
        return;
      }
      renderPurchases(filtered);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BUNDLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BUNDLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function loadBundlesData() {
      const { data, error } = await window.supabase
        .from('purchases').select('*').eq('song_id', 'pack:5').order('created_at', { ascending: false });
      if (error) throw error;
      allBundles = data || [];
    }
    
    async function loadBundles() {
      try {
        document.getElementById('bundlesTableBody').innerHTML =
          '<tr><td colspan="4" class="loading"><div class="spinner"></div>Loading bundles...</td></tr>';
        await loadBundlesData();
        updateSortHeaders('bundles');
        renderBundles(sortArray(allBundles, 'bundles'));
      } catch (e) {
        console.error('Error:', e);
        document.getElementById('bundlesTableBody').innerHTML =
          `<tr><td colspan="4"><div class="error-message">Error: ${e.message}</div></td></tr>`;
      }
    }
    
    function renderBundles(list) {
      const data = list || allBundles;
      const tbody = document.getElementById('bundlesTableBody');
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><div class="empty-state-icon">üì¶</div><p>No bundle purchases found</p></td></tr>';
        return;
      }
      tbody.innerHTML = data.map(b => {
        const profile = getProfile(b.user_id);
        const totalBundles = getBundleCountForUser(b.user_id);
        return `<tr>
          <td>${userInfoHTML(profile?.display_name, profile?.email)}</td>
          <td><span class="badge badge-success">${totalBundles}</span></td>
          <td><span class="badge badge-success">${b.credits_remaining || 0}</span></td>
          <td>${new Date(b.created_at).toLocaleString()}</td>
        </tr>`;
      }).join('');
    }
    
    function filterBundles() {
      const q = document.getElementById('bundleSearch').value.toLowerCase();
      const filtered = allBundles.filter(b => {
        const profile = getProfile(b.user_id);
        return (
          b.user_id.toLowerCase().includes(q) ||
          (profile?.display_name?.toLowerCase().includes(q)) ||
          (profile?.email?.toLowerCase().includes(q))
        );
      });
      if (!filtered.length) {
        document.getElementById('bundlesTableBody').innerHTML =
          '<tr><td colspan="4" class="empty-state"><div class="empty-state-icon">üîç</div><p>No bundles match your search</p></td></tr>';
        return;
      }
      renderBundles(filtered);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PRICING MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DB stores in smallest unit (cents / paise).
    // UI shows in dollars / rupees.
    // On LOAD:  divide DB value by 100 ‚Üí show in input.
    // On SAVE:  multiply input by 100  ‚Üí store in DB.
    // Exchange rates: fetched live, converted to the format the backend expects.
    
    async function loadPricingData() {
      try {
        const { data, error } = await window.supabase
          .from('pricing_config').select('*').eq('id', 1).single();

        if (error) {
          console.log('No pricing config found, using defaults');
          // Fill with human-readable defaults
          setInputDollars('usd_books_first', 8);
          setInputDollars('usd_books_second', 7);
          setInputDollars('usd_books_third', 7);
          setInputDollars('usd_books_bundle', 34);
          setInputDollars('usd_nobooks_first', 10);
          setInputDollars('usd_nobooks_second', 9);
          setInputDollars('usd_nobooks_third', 8);
          setInputDollars('usd_nobooks_bundle', 40);
          setInputDollars('inr_books_first', 150);
          setInputDollars('inr_books_second', 129);
          setInputDollars('inr_books_third', 100);
          setInputDollars('inr_books_bundle', 550);
          setInputDollars('inr_nobooks_first', 200);
          setInputDollars('inr_nobooks_second', 180);
          setInputDollars('inr_nobooks_third', 150);
          setInputDollars('inr_nobooks_bundle', 850);
          return;
        }

        const config = data.config;

        // USD ‚Äî DB is in cents, divide by 100 for display
        setInputDollars('usd_books_first',   config.USD.withBooks.first);
        setInputDollars('usd_books_second',  config.USD.withBooks.second);
        setInputDollars('usd_books_third',   config.USD.withBooks.third);
        setInputDollars('usd_books_bundle',  config.USD.withBooks.bundle);
        setInputDollars('usd_nobooks_first', config.USD.withoutBooks.first);
        setInputDollars('usd_nobooks_second',config.USD.withoutBooks.second);
        setInputDollars('usd_nobooks_third', config.USD.withoutBooks.third);
        setInputDollars('usd_nobooks_bundle',config.USD.withoutBooks.bundle);

        // INR ‚Äî DB is in paise, divide by 100 for display
        setInputDollars('inr_books_first',   config.INR.withBooks.first);
        setInputDollars('inr_books_second',  config.INR.withBooks.second);
        setInputDollars('inr_books_third',   config.INR.withBooks.third);
        setInputDollars('inr_books_bundle',  config.INR.withBooks.bundle);
        setInputDollars('inr_nobooks_first', config.INR.withoutBooks.first);
        setInputDollars('inr_nobooks_second',config.INR.withoutBooks.second);
        setInputDollars('inr_nobooks_third', config.INR.withoutBooks.third);
        setInputDollars('inr_nobooks_bundle',config.INR.withoutBooks.bundle);

        // Also fetch live rates while we're here
        await fetchLiveRates();
      } catch (e) {
        console.error('Error loading pricing:', e);
      }
    }

    // Helper: set input value from DB cents/paise ‚Üí human dollars/rupees
    function setInputDollars(inputId, centsValue) {
      const el = document.getElementById(inputId);
      if (el) {
        const human = (centsValue || 0) / 100;
        // Show clean number: remove trailing zeros after decimal
        el.value = parseFloat(human.toFixed(2));
      }
    }

    // Helper: read input value in human dollars/rupees ‚Üí convert to cents/paise for DB
    function getInputCents(inputId) {
      const el = document.getElementById(inputId);
      const val = parseFloat(el?.value) || 0;
      return Math.round(val * 100); // e.g. 8.50 ‚Üí 850
    }

    async function savePricing() {
      const statusDiv = document.getElementById('pricingStatus');
      statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Saving pricing changes...</div>';

      try {
        // Build the config object ‚Äî multiply human values by 100 for DB storage
        const config = {
          USD: {
            withBooks: {
              first:  getInputCents('usd_books_first'),
              second: getInputCents('usd_books_second'),
              third:  getInputCents('usd_books_third'),
              bundle: getInputCents('usd_books_bundle'),
            },
            withoutBooks: {
              first:  getInputCents('usd_nobooks_first'),
              second: getInputCents('usd_nobooks_second'),
              third:  getInputCents('usd_nobooks_third'),
              bundle: getInputCents('usd_nobooks_bundle'),
            },
          },
          INR: {
            withBooks: {
              first:  getInputCents('inr_books_first'),
              second: getInputCents('inr_books_second'),
              third:  getInputCents('inr_books_third'),
              bundle: getInputCents('inr_books_bundle'),
            },
            withoutBooks: {
              first:  getInputCents('inr_nobooks_first'),
              second: getInputCents('inr_nobooks_second'),
              third:  getInputCents('inr_nobooks_third'),
              bundle: getInputCents('inr_nobooks_bundle'),
            },
          },
          lastUpdated: new Date().toISOString(),
        };

        // ‚îÄ‚îÄ Exchange rates ‚îÄ‚îÄ
        // Backend expects: { USD: 1, INR: 83, GBP: 0.79, ... }
        // meaning "1 USD = X currency"  (USD-base format)
        //
        // Frankfurter gave us INR-base: { USD: 0.0118, GBP: 0.0093, ... }
        // meaning "1 INR = X currency"
        //
        // Convert: 1 USD = (1/rates.USD) INR  ‚Üí  INR value = 1 / rates.USD
        // Then for any other currency C:  1 USD = rates.C / rates.USD  units of C

        if (liveExchangeRates && liveExchangeRates.USD) {
          const inrPerUsd = 1 / liveExchangeRates.USD; // e.g. 1/0.0118 ‚âà 84.7
          const exchangeRates = { USD: 1, INR: parseFloat(inrPerUsd.toFixed(2)) };

          // For every other currency we have: 1 USD = liveRate[C] / liveRate[USD]
          RATE_CURRENCIES.forEach(code => {
            if (code === 'USD') return;
            if (liveExchangeRates[code] != null) {
              exchangeRates[code] = parseFloat((liveExchangeRates[code] / liveExchangeRates.USD).toFixed(4));
            }
          });

          // Also add the extra currencies the backend fallback has (we keep them from previous config or skip)
          // For now we just save what we have ‚Äî the backend FALLBACK_PRICING covers the rest if missing.
          config.exchangeRates = exchangeRates;
        } else {
          // No live rates available ‚Äî try to load existing from DB so we don't wipe them
          try {
            const { data: existing } = await window.supabase
              .from('pricing_config').select('config').eq('id', 1).single();
            if (existing?.config?.exchangeRates) {
              config.exchangeRates = existing.config.exchangeRates;
            }
          } catch(_) {}

          if (!config.exchangeRates) {
            statusDiv.innerHTML = `<div class="error-message">‚ö†Ô∏è Could not fetch live exchange rates and no previous rates found. Please click "Refresh Rates" first.</div>`;
            return;
          }
        }

        const { error } = await window.supabase
          .from('pricing_config')
          .upsert({
            id: 1,
            config: config,
            updated_at: new Date().toISOString(),
          });

        if (error) throw error;

        statusDiv.innerHTML = `
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 12px; padding: 20px; color: var(--success);">
            <strong>‚úÖ Pricing updated successfully!</strong><br>
            <span style="font-size: 13px;">Changes apply to all new purchases immediately. Exchange rates: ${config.exchangeRates ? '‚úÖ saved' : '‚ö†Ô∏è not updated'}</span>
          </div>
        `;

        setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
      } catch (e) {
        console.error('Error saving pricing:', e);
        statusDiv.innerHTML = `<div class="error-message"><strong>‚ùå Failed to save pricing:</strong><br>${e.message}</div>`;
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchTab(tabName, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  document.getElementById(tabName + 'Tab').classList.remove('hidden');
  
  if (tabName === 'pricing') {
    loadPricingData();
  }
  if (tabName === 'sheetmusic') {
    loadSheetMusic();
  }
}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MEDIA LIGHTBOX
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function openMediaModal(type, url) {
      const overlay = document.getElementById('mediaModal');
      const img = document.getElementById('mediaModalImg');
      const vid = document.getElementById('mediaModalVideo');
      if (type === 'photo') {
        img.src = url; img.style.display = 'block';
        vid.style.display = 'none'; vid.pause(); vid.src = '';
      } else {
        vid.src = url; vid.style.display = 'block';
        img.style.display = 'none'; img.src = '';
      }
      overlay.classList.remove('hidden');
    }
    function closeMediaModal() {
      document.getElementById('mediaModal').classList.add('hidden');
      const vid = document.getElementById('mediaModalVideo');
      vid.pause(); vid.src = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SORTING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let sortState = {
      users:     { col: 'joined',    dir: 'desc' },
      codes:     { col: 'generated', dir: 'desc' },
      purchases: { col: 'date',      dir: 'desc' },
      bundles:   { col: 'date',      dir: 'desc' }
    };

    function getSortValue(item, table, col) {
      const p = getProfile(item.user_id || item.id);
      switch (table) {
        case 'users':
          if (col === 'name')   return (item.display_name || '').toLowerCase();
          if (col === 'joined') return item.created_at || '';
          break;
        case 'codes':
          if (col === 'book')      return (item.book_name || '').toLowerCase();
          if (col === 'generated') return item.created_at || '';
          if (col === 'used')      return item.used_at || '';
          break;
        case 'purchases':
          if (col === 'name')   return (p?.display_name || '').toLowerCase();
          if (col === 'song')   return (item.song_id || '').toLowerCase();
          if (col === 'amount') return item.amount || 0;
          if (col === 'date')   return item.created_at || '';
          break;
        case 'bundles':
          if (col === 'name')        return (p?.display_name || '').toLowerCase();
          if (col === 'bundlecount') return getBundleCountForUser(item.user_id) || 0;
          if (col === 'credits')     return item.credits_remaining || 0;
          if (col === 'date')        return item.created_at || '';
          break;
      }
      return '';
    }

    function sortArray(arr, table) {
      const { col, dir } = sortState[table];
      return [...arr].sort((a, b) => {
        let va = getSortValue(a, table, col);
        let vb = getSortValue(b, table, col);
        let cmp = 0;
        if (typeof va === 'number' && typeof vb === 'number') {
          cmp = va - vb;
        } else {
          va = String(va); vb = String(vb);
          cmp = va < vb ? -1 : va > vb ? 1 : 0;
        }
        return dir === 'asc' ? cmp : -cmp;
      });
    }

    function updateSortHeaders(table) {
      document.querySelectorAll(`th[data-table="${table}"]`).forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.col === sortState[table].col) {
          th.classList.add('sort-' + sortState[table].dir);
        }
      });
    }

    function initSortHeaders() {
      document.querySelectorAll('th[data-sortable]').forEach(th => {
        th.addEventListener('click', () => {
          const table = th.dataset.table;
          const col   = th.dataset.col;
          if (sortState[table].col === col) {
            sortState[table].dir = sortState[table].dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState[table] = { col, dir: 'asc' };
          }
          updateSortHeaders(table);
          switch (table) {
            case 'users':     renderUsers(sortArray(allUsers, 'users'));             break;
            case 'codes':     renderCodes(sortArray(allCodes, 'codes'));             break;
            case 'purchases': renderPurchases(sortArray(allPurchases, 'purchases')); break;
            case 'bundles':   renderBundles(sortArray(allBundles, 'bundles'));       break;
          }
        });
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DELETE USER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function openDeleteModal(user) {
      if (ADMIN_EMAILS.includes(user.email)) {
        alert('‚õî Cannot delete admin accounts!\n\nAdmin emails are protected and cannot be deleted.');
        return;
      }
      userToDelete = user;
      document.getElementById('deleteUserName').textContent = user.display_name || 'Unknown';
      document.getElementById('deleteUserEmail').textContent = user.email || 'N/A';

      document.getElementById('confirmStep1').classList.remove('hidden');
      document.getElementById('confirmStep2').classList.add('hidden');
      document.getElementById('confirmStep3').classList.add('hidden');
      document.getElementById('deletingStep').classList.add('hidden');
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
      userToDelete = null;
    }

    function confirmStep2() {
      document.getElementById('confirmStep1').classList.add('hidden');
      document.getElementById('confirmStep2').classList.remove('hidden');
    }

    function confirmStep3() {
      document.getElementById('confirmStep2').classList.add('hidden');
      document.getElementById('confirmStep3').classList.remove('hidden');
    }

    async function deleteUserForever() {
      if (!userToDelete) return;
      document.getElementById('confirmStep3').classList.add('hidden');
      document.getElementById('deletingStep').classList.remove('hidden');
    
      try {
        const userId = userToDelete.id;
    
        await window.supabase.from('purchases').delete().eq('user_id', userId);
        await window.supabase.from('user_credits').delete().eq('user_id', userId);
        await window.supabase.from('entitlements').delete().eq('user_id', userId);
        await window.supabase.from('payment_orders').delete().eq('user_id', userId);
        await window.supabase.from('progress').delete().eq('user_id', userId);
        await window.supabase.from('song_progress').delete().eq('user_id', userId);
    
        await window.supabase.from('book_verification_codes')
          .update({ used_by_user_id: null, is_used: false, used_at: null })
          .eq('used_by_user_id', userId);
    
        await window.supabase.from('profiles').delete().eq('id', userId);
    
        const { data: { session } } = await window.supabase.auth.getSession();
        
        if (!session || !session.user) {
          throw new Error('Not authenticated');
        }
    
        console.log('Calling remove_song_access with:', {
          userId: userId,
          email: session.user.email
        });
    
        const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId }),
        });
    
        const result = await response.json();
        console.log('Delete user response:', result);
        
        if (!response.ok) throw new Error(result.error || 'Failed to delete auth user');
    
        alert('‚úÖ User completely deleted!');
        closeDeleteModal();
    
        delete photoCache[userId];
        delete videoCache[userId];
    
        await Promise.all([loadPurchasesData(), loadBundlesData()]);
        loadStats();
        loadUsers();
        loadCodes();
        renderPurchases(sortArray(allPurchases, 'purchases'));
        renderBundles(sortArray(allBundles, 'bundles'));
      } catch (e) {
        console.error('Delete error:', e);
        alert('‚ùå Error: ' + e.message);
        
        // Show step 3 again so user can retry
        document.getElementById('deletingStep').classList.add('hidden');
        document.getElementById('confirmStep3').classList.remove('hidden');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    document.getElementById('endDate').valueAsDate = new Date();
    const _startDate = new Date();
    _startDate.setDate(_startDate.getDate() - 30);
    document.getElementById('startDate').valueAsDate = _startDate;

    checkAdminAccess();
  </script>
</body>
</html>
